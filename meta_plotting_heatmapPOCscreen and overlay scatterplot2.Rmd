

#plan: gebruik data van live heatmap meta plotting (want die heb ik eerst aangepast) om de end-point data heatmap te maken.


```{r}
rm(list=ls())
setwd("D:/POC/POC meta analyse/full")

require(ggplot2)
require(NMF)
require(stringr)
require(data.table)
require(grid)
source("D:/R_HOME/R_WORK/R scipts/theme_sharp.R")
options(stringsAsFactors=FALSE)
all.files <- dir("summary files")

all.paths <- as.list(paste("summary files", all.files, sep = "/"))

cellineStr<-lapply(all.paths, str_match,"( [A-Z a-z 0-9]{3,15}).txt")

cellineStr<-lapply(cellineStr, "[[",2)
cellineStr <- lapply(cellineStr, gsub, pattern=' ', replacement='')

plateStr <- lapply(all.paths, str_match, "[0-9]{4}_[0-9]{2}_[0-9]{2} myData_summarized[ A-Z a-z 0-9 _ -]{1,28}.txt")
plateStr<- lapply(plateStr, gsub, pattern ='.txt' , replacement ='')
plateStr<- lapply(plateStr, gsub, pattern =' myData_summarized' , replacement ='')

names(all.paths)<-plateStr


# read in data:
data.raw=list()
  for(i in seq_along(all.paths)){
    print(i)
    data.raw[[i]] <- fread(all.paths[[i]], sep ="\t", header = TRUE)
    data.raw[[i]][,V1:=NULL]
    }
#verify cell line inside and out
for( i in seq_along(all.paths)){
print(i)
  print(paste(all.paths[i],unique(data.raw[[i]]$cell_line), sep ="___"))
print(cellineStr[i])
}

# fix all inconsistancies accros datasets.
   # fix cell line names:
for( i in seq_along(data.raw)){
  data.raw[[i]]$cell_line <- cellineStr[i]
}

# fix / standardize all compound names & remove compounds not of interest:

all.comps<- lapply(data.raw, "[[", "treatment")
all.comps<-unlist(all.comps)
all.comps<- unique(all.comps)
comps.keep<- c("BFA","CCCP", "CDDO","Cisplatin","DEM","DMEM","DMSO 25%","DMSO 50%",
               "DMSO 75%","DMSO max","Etoposide","H2O2","Iodoacetamide","Menadione","Nocodazole","Oligomycin B",
               "Thapsigargin","Tunicamycin","DMSO","Staurosporin","DMSO 100%","IAA", "Chlorpromazine","DMNQ")
length(comps.keep)
data.raw.t<- lapply(data.raw, function(x) {x<-x[ treatment %in% comps.keep,] })

lapply(data.raw.t, function(x) unique(x$treatment))

all.comps<- lapply(data.raw.t, "[[", "treatment")
all.comps<-unlist(all.comps)
all.comps<- unique(all.comps)

data.raw<-data.raw.t
data.raw.t<- lapply(data.raw, function(x){ 
   x[ ,treatment:= gsub("Iodoacetamide", "IAA",treatment)]})
data.raw<-data.raw.t
# fix DMSO

# fix feature data
all.feats <- unique(unlist(lapply(data.raw,"[[","variable")))
#data.raw
names(data.raw[[71]])

setnames(data.raw[[71]], "Cells_Children_obj_foci_Count", "value")
data.raw[[71]]$variable <- "Cells_Children_obj_foci_Count"

setnames(data.raw[[74]], "Cells_Children_obj_foci_Count", "value")
data.raw[[74]]$variable <- "Cells_Children_obj_foci_Count"

all.feats <- unique(unlist(lapply(data.raw,"[[","variable")))


# [1] "Cytoplasm_Intensity_MeanIntensity_img_gfp"                               "Cytoplasm_Intensity_IntegratedIntensity_img_gfp"                        
#  [3] "Nuclei_AreaShape_Area"                                                   "Nuclei_Intensity_MeanIntensity_img_hoechst"                             
#  [5] "Displacement"                                                            "imageCountTracked"                                                      
#  [7] "Nuclei_Intensity_MeanIntensity_img_gfp"                                  "Nuclei_Intensity_IntegratedIntensity_img_gfp"                           
#  [9] "obj_nc_Intensity_MeanIntensity_img_cyto"                                 "obj_nc_Intensity_IntegratedIntensity_img_cyto"                          
# [11] "obj_nc_AreaShape_Area"                                                   "obj_nc_Intensity_MeanIntensity_img_nc"                                  
# [13] "obj_nc_Intensity_MeanIntensity_gfp_img"                                  "obj_nc_Intensity_IntegratedIntensity_gfp_img"                           
# [15] "obj_nc_Intensity_MeanIntensity_nc_image"                                 "Cytoplasm_Intensity_MeanIntensity_gfp_img"                              
# [17] "Cytoplasm_Intensity_IntegratedIntensity_gfp_img"                         "obj_cyto_only_Intensity_MeanIntensity_img_cyto"                         
# [19] "obj_cyto_only_Intensity_IntegratedIntensity_img_cyto"                    "Cytoplasm_Intensity_MeanIntensity_img_cyto"                             
# [21] "Cyto_only_Intensity_MeanIntensity_img_cyto"                              "obj_nc_Children_filtered_foci_Count"                                    
# [23] "obj_nc_Intensity_MeanIntensity_img_gfp"                                  "filtered_foci_AreaShape_Area"                                           
# [25] "filtered_foci_Intensity_MeanIntensity_img_gfp"                           "Image_AreaOccupied_AreaOccupied_filtered_foci"                          
# [27] "count_obj_cyto_only_Intensity_IntegratedIntensity_img_cyto_larger_1.606" "count_obj_cyto_only_Intensity_IntegratedIntensity_img_cyto_larger_2.409"
# [29] "obj_nc_TrackObjects_DistanceTraveled_30"                                 "obj_foci_Intensity_MeanIntensity_img_gfp"                               
# [31] "obj_foci_AreaShape_Area"                                                 "obj_nc_Children_obj_foci_Count"                                         
# [33] "obj_nc_TrackObjects_DistanceTraveled_80"                                 "Cells_Children_obj_foci_Count"                                          
# [35] "obj_nc_Intensity_IntegratedIntensity_img_gfp"                           

  
convertToo1<- "Cytoplasm_Intensity_MeanIntensity_img_gfp"  
convert1 <- c("Cytoplasm_Intensity_MeanIntensity_gfp_img", "obj_cyto_only_Intensity_MeanIntensity_img_cyto", "Cytoplasm_Intensity_MeanIntensity_img_cyto","Cyto_only_Intensity_MeanIntensity_img_cyto")
convertToo2 <- "Cytoplasm_Intensity_IntegratedIntensity_img_gfp"
convert2<- c("Cytoplasm_Intensity_IntegratedIntensity_gfp_img", "obj_cyto_only_Intensity_IntegratedIntensity_img_cyto")
convertToo3 <- "Nuclei_AreaShape_Area"
convert3<- "obj_nc_AreaShape_Area"
convertToo4<-  "Nuclei_Intensity_MeanIntensity_img_hoechst"
convert4<- c("obj_nc_Intensity_MeanIntensity_img_nc", "obj_nc_Intensity_MeanIntensity_nc_image")
convertToo5 <- "Displacement"
convert5 <- c("obj_nc_TrackObjects_DistanceTraveled_30", "obj_nc_TrackObjects_DistanceTraveled_80")
convertToo6<- "imageCountTracked"
#convert6
convertToo7 <- "Nuclei_Intensity_MeanIntensity_img_gfp"
convert7<- c("obj_nc_Intensity_MeanIntensity_img_cyto", "obj_nc_Intensity_MeanIntensity_gfp_img","obj_nc_Intensity_MeanIntensity_img_gfp")   

convertToo8<- "Foci_Count"
convert8 <- c("obj_nc_Children_filtered_foci_Count", "obj_nc_Children_obj_foci_Count", "Cells_Children_obj_foci_Count")

convertToo9<- "filtered_foci_AreaShape_Area"
convertToo10<- "filtered_foci_Intensity_MeanIntensity_img_gfp"
convertToo11<- "Image_AreaOccupied_AreaOccupied_filtered_foci"
convertToo12<- "Cells_Children_filtered_foci_Count"

convertToo13 <- "Nuclei_Intensity_IntegratedIntensity_img_gfp"
convert13 <- c("obj_nc_Intensity_IntegratedIntensity_img_gfp", "obj_nc_Intensity_IntegratedIntensity_img_cyto", "obj_nc_Intensity_IntegratedIntensity_gfp_img")
keep<-c(convertToo1,convertToo2,convertToo3,convertToo4,convertToo5,convertToo6,convertToo7,
        convertToo8,convertToo9,convertToo10,convertToo11,convertToo12,convertToo13)
  
data.rawBKUP <- data.raw



for( i in seq_along(data.raw)){
  if( "value" %in% names(data.raw[[i]]) ) {
  setnames(data.raw[[i]], "value", "meanSummaryStat")
  } 
  
}

#data.raw 
# conversions:  
  lapply(data.raw, names)

for( i in seq_along(convert1)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert1[i], convertToo1,variable)]
  })
  }  
  
for( i in seq_along(convert2)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert2[i], convertToo2,variable)]
  })
  } 
for( i in seq_along(convert3)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert3[i], convertToo3,variable)]
  })
  } 
for( i in seq_along(convert4)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert4[i], convertToo4,variable)]
  })
  } 
for( i in seq_along(convert4)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert5[i], convertToo5,variable)]
  })
  }
for( i in seq_along(convert7)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert7[i], convertToo7,variable)]
  })
  } 
for( i in seq_along(convert8)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert8[i], convertToo8,variable)]
  })
  } 
for( i in seq_along(convert8)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert13[i], convertToo13,variable)]
  })
  } 

  data.raw<-lapply(data.raw, function(x){x<-x[variable%in%keep] })

which(unlist(lapply( data.raw, function(x) "allVarCells" %in% names(x))))
data.raw[[60]]$allVarCells <- NULL

lapply(data.raw, length)

unique(lapply(data.raw1, names))


for(i in seq_along(data.raw)){
data.raw[[i]]$plateID <- plateStr[i]
  
}

data.raw1 <- lapply(data.raw, function(x) x<-x[, n:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, error95:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, sd:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, doseLevel:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, timeID:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, control:=NULL] )
data.raw <- data.raw1

coln <- c("treatment" ,        "dose_uM"   ,        "timeAfterExposure" ,"control"      ,     "cell_line"       ,  "variable"     ,     "meanSummaryStat"  , "plateID")       
which(!unlist(lapply(data.raw, function(x) all(  names(x) %in% coln ))))



data.raw.dt<- do.call("rbind", data.raw)
data.raw.dt[, minmaxNorm:= (meanSummaryStat - min(meanSummaryStat,na.rm=TRUE))/ 
              (max(meanSummaryStat, na.rm=TRUE) - min(meanSummaryStat,na.rm=TRUE)),
            by= list(plateID, variable)]

unique(data.raw.dt[, plateID])

data.raw.dt[,timeAfterExposure:= as.numeric(timeAfterExposure)]

all.treats<-unique(data.raw.dt[,treatment])
data.raw.dt[, treatment:= gsub("DMSO 25%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO 50%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO 75%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO 100%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO max", "DMSO", treatment)]


unique(cellineStr)

setkey(data.raw.dt,"cell_line")

data.cell_line <- data.raw.dt["KEAP1"]
unique(data.cell_line$plateID)



#keep_plateIDs <- c("2014_06_27 NFE2L2" ,"2014_06_30 NFE2L2", "2014_07_03 NFE2L2")
#data.cell_line<-data.cell_line[!plateID %in% "2013_03_13 TP53BP1"]
unique(data.cell_line$variable)
keep_feats <- c("Nuclei_Intensity_MeanIntensity_img_gfp","Nuclei_AreaShape_Area","Displacement","imageCountTracked")
keep_feats <- c("Foci_Count")


data.cell_line<-data.cell_line[variable %in% keep_feats]

 

p<- ggplot( data =data.cell_line ,  aes( x = timeAfterExposure , y = meanSummaryStat,
                                                  , colour = plateID, shape = plateID  )) +
                    geom_point( size = 2, na.rm = TRUE )  +
  geom_line( aes(group = plateID, colour = plateID) )
        
p <- p + facet_wrap( ~treatment+dose_uM   ) 
      p <- p + theme_sharp() +
        theme( axis.text.x = element_text(angle = 90, hjust = 1, size = as.numeric(6) ) ) + 
        theme( strip.text.x = element_text( size = as.numeric(6) )) +
        ggtitle( paste(unique(data.cell_line$cell_line ), unique(data.cell_line$variable)) ) + 
        theme(plot.title = element_text(lineheight=.8, size = 1.6*as.numeric(8)))   + theme(legend.position = "bottom") +
  theme(legend.text=element_text(size= 0.8*as.numeric(8)))
        
p+ scale_shape_manual( values = 1:length(unique(data.cell_line$plateID))) #+ ylim(0,5)



# selected data based on previous plot

# heatmap of final timepoint selected data




# create treatment_dose levels & gather all treatment_dose in a vector:
  
 
# Menadione_2.5 moet 5 zijn?
# 
# 
# goed:
# CDDO_0.03
# CDDO_0.015
# CDDO_0.0075
# 
# niet goed:
# CDDO_0.05
# CDDO_0.025
# CDDO 0.0125
head(data.raw.dt)
data.raw.dt[ data.raw.dt$treatment == "Menadione" & data.raw.dt$dose_uM == "2.5", "dose_uM"] <- "5"
data.raw.dt[ data.raw.dt$treatment == "CDDO" & data.raw.dt$dose_uM == "0.05", "dose_uM"] <- "0.03"
data.raw.dt[ data.raw.dt$treatment == "CDDO" & data.raw.dt$dose_uM == "0.025", "dose_uM"] <- "0.015"
data.raw.dt[ data.raw.dt$treatment == "CDDO" & data.raw.dt$dose_uM == "0.0125", "dose_uM"] <- "0.0075"
unique(data.raw.dt$treatment)
data.raw.dt<- data.raw.dt[!treatment %in% c("CCCP", "Nocodazole", "Oligomycin B",  "Chlorpromazine", "DMNQ", "Menadione")  ,] # including starosporin here
dim(data.raw.dt)
# generate figure 1 (heatmap) (based on mean values for now, # of cells above bckgr is next step)


minmaxFun <- function(x) { 
                          min_e = min(x, na.rm = TRUE)
                          max_e = max(x, na.rm = TRUE)
                          y <- (x - min_e) / (max_e - min_e)
                          y
                          }

# select data
selPlateIDs <- c("2013_01_16 HSPA5",  "2013_01_31 HSPA5", "2013_02_06 HSPA5",
 "2014_06_27 NFE2L2", "2014_06_30 NFE2L2", "2014_07_03 NFE2L2",
 "2013_01_16 XBP1",  "2013_02_06 XBP1",
  "2013_01_16 DDIT3", "2013_03_13 DDIT3", "2013_03_20 DDIT3",
   "2012_12_10 ATF4", "2012_12_14 ATF4", "2012_12_19 ATF4",
	"2012_12_10 TP53", "2012_12_14 TP53",	   "2012_12_19 TP53",
 "2013_03_13 SRXN1",    "2013_03_20 SRXN1", 	"2013_02_27 SRXN1",
 "2013_10_10 KEAP1",   "2013_10_16 KEAP1", 	"2013_10_30 KEAP1",
  "2013_03_20 TP53BP1",   "2014_06_30 TP53BP1",	 "2014_07_03 TP53BP1",
  "2013_10_10 BTG2", "2013_10_16 BTG2",	"2013_10_30 BTG2",
  "2013_10_10 p21", "2013_10_16 p21", "2013_10_30 p21")
selPlateIDs<- unique(selPlateIDs)
length(selPlateIDs)
my.data <- data.raw.dt[ plateID %in% selPlateIDs,]
length(unique(my.data$plateID))
which(!selPlateIDs %in% my.data$plateID)

unique(my.data$variable)
#select the response data
my.data[, cell_line.var := paste(cell_line, variable)]
my.data[, treat.dose := paste(treatment, dose_uM)]
unique(my.data[,cell_line.var])
sel.c <- c("ATF4 Nuclei_Intensity_MeanIntensity_img_gfp","BTG2 Cytoplasm_Intensity_IntegratedIntensity_img_gfp",
           "DDIT3 Nuclei_Intensity_MeanIntensity_img_gfp", "HSPA5 Cytoplasm_Intensity_IntegratedIntensity_img_gfp",
           "KEAP1 Foci_Count", "NFE2L2 Nuclei_Intensity_MeanIntensity_img_gfp", 
           "SRXN1 Cytoplasm_Intensity_IntegratedIntensity_img_gfp", "TP53 Nuclei_Intensity_MeanIntensity_img_gfp",
           "TP53BP1 Foci_Count",
           "XBP1 Nuclei_Intensity_MeanIntensity_img_gfp", "p21 Nuclei_Intensity_MeanIntensity_img_gfp")



my.data.response <- my.data[ cell_line.var %in% sel.c ,]
dim(my.data.response)
head(my.data.response)
# must have 3 plates per readout except for XBP1 which has 2 readouts:
my.data.response$cellSpecReadoutPlate <- paste(my.data.response$cell_line.var, my.data.response$plateID, sep ="_")
unique(my.data.response$cellSpecReadoutPlate)
(11*3-1) == length(unique(my.data.response$cellSpecReadoutPlate))

my.data.response[, minmaxNorm:=NULL]
my.data.response[, minmaxNorm:= (meanSummaryStat - min(meanSummaryStat,na.rm=TRUE))/ 
              (max(meanSummaryStat, na.rm=TRUE) - min(meanSummaryStat,na.rm=TRUE)),
            by= list(plateID, variable, cell_line)]






#collapse time, choose 1 before last tp. remove last point, then choose max point
require(plyr)
my.data.response.ltpMin1<- ddply(my.data.response,~plateID+treatment+dose_uM+cell_line,
                                 function(x){x[which(x$timeAfterExposure != (max(x$timeAfterExposure))),]})
my.data.response.ltpMin1<- ddply(my.data.response.ltpMin1,~plateID+treatment+dose_uM+cell_line,
                                 function(x){x[which(x$timeAfterExposure == (max(x$timeAfterExposure))),]})
# ff max ipv een-na-laatste
#my.data.response.ltpMin1<- ddply(my.data.response, .(plateID, treat.dose), transform, peakV= minmaxNorm == max(minmaxNorm, na.rm=TRUE))
#sum(my.data.response.ltpMin1$peakV)
head(my.data.response.ltpMin1)
#my.data.response.ltpMin1 <- my.data.response.ltpMin1[ my.data.response.ltpMin1$peakV == TRUE, ]

max(unique(my.data.response.ltpMin1$timeAfterExposure))
max(unique(my.data.response$timeAfterExposure))


# calculate mean  of replicates
unique(my.data.response.ltpMin1$timeAfterExposure)
my.data.response.mean <- ddply(my.data.response.ltpMin1, .(cell_line, treatment, dose_uM, treat.dose, variable),
                               summarize, meanV = mean(minmaxNorm, na.rm=TRUE))


head(my.data.response.mean)
dim(my.data.response.mean)
require(reshape2)
my.data.w <-  dcast(data = my.data.response.mean, treat.dose ~ cell_line, value.var = "meanV" )
max(my.data.w, na.rm=T)
head(my.data.w)
unique(my.data.w$treat.dose)



rownames(my.data.w) <- my.data.w$treat.dose
my.data.w$treat.dose<- NULL
# define annotations treatment and reporter types:



# heatmap time!

reporter_type <- c("light blue", "darkred", "green")
treatment_type <- c("light blue", "darkred", "green", "orange")

names(reporter_type) <- c("ox_stress", "DDR", "ER_stress")
names(treatment_type) <-  c( "ox_stress","DDR","ER_stress", "control"  )

#treatmentAnot <- data.frame(treatment = rownames(my.data.w)
                            )
getwd()
#write.table(treatmentAnot, file = "treatmentAnot2.txt", col.names=T, sep ="\t", row.names = F)
treatmentAnot <- read.table(file = "treatmentAnot.txt", sep ="\t", header = TRUE)

#treatmentAnot[ treatmentAnot$type == "DILI", "type"] <- "ox_stress"

                     

treatmentAnot<- treatmentAnot[ treatmentAnot$treatment %in% rownames(my.data.w), ]
colnames(treatmentAnot)<-c("treatment", "treatment_type")


# put treatmentAnot in correct order
ind <- match( rownames(my.data.w),treatmentAnot$treatment)


treatmentAnot <- treatmentAnot[ ind, ]

treatmentAnot <- as.data.frame(treatmentAnot$treatment_type)
colnames(treatmentAnot) <- "treatment_type"

colnames(my.data.w)
"ATF4"    "BTG2"    "DDIT3"   "HSPA5"   "KEAP1"   "NFE2L2"  "p21"     "SRXN1"   "TP53"    "TP53BP1" "XBP1"   
# reporterAnot <- data.frame(reporter = c("srxn1","keap1","nrf2","tp53bp1", "p53", "p21", "btg2","atf4","xbp1","BiP","chop"),
#                            reporter_type = c("ox_stress", "ox_stress", "ox_stress", "DDR", "DDR", "DDR", "DDR", 
#                                              "ER_stress","ER_stress","ER_stress","ER_stress"))



colnames(my.data.w)

reporterAnot<- data.frame(reporter_type = c("ER_stress", "ER_stress", "DDR","ER_stress", "ox_stress", "ox_stress", "DDR","DDR","DDR", "ox_stress",  "ER_stress"))

colnames(reporterAnot)  <- "reporter_type"
my.colors <- c( "#ffffb2", "#fed976", "#feb24c", "#fd8d3c", "#f03b20", "#bd0026")
hist(rep(1:10, 10), col =my.colors)

length(my.colors) 

myColors <- list(reporter_type = reporter_type, treatment_type = treatment_type)


colBreaks <-c(seq(-0.1, 0.1,length.out=20), seq(0.101,1.01, length.out = 31))
length(colBreaks)

breaks = colBreaks,
?aheatmap

#replace Nrf2 stauro by mean of resp. rows to be able to cluster. Replace by NA afterwards

rowMeans(my.data.w, na.rm=TRUE)
Staurosporin 10  Staurosporin 2.5    Staurosporin 5 
  0.05070572        0.11262591        0.06643412

my.data.w[ rownames(my.data.w) == "Staurosporin 10" , colnames(my.data.w) == "NFE2L2"] <- 0.05070572
my.data.w[ rownames(my.data.w) == "Staurosporin 2.5" , colnames(my.data.w) == "NFE2L2"] <- 0.11262591
my.data.w[ rownames(my.data.w) == "Staurosporin 5" , colnames(my.data.w) == "NFE2L2"] <- 0.06643412

#use model.results.dt from live heatmap code( just modified that 1)
model.results.dt <- as.data.table(model.results.df.m)
#select foremost final timepoint:

model.results.dt[, maxTime:= max(timeAfterExposure)-0.1 , by = c("cell_line","treat.dose")]
model.results.dt <- model.results.dt[timeAfterExposure== 19.9]
model.results.dt.w <- dcast(model.results.dt, cell_line ~ treat.dose, value.var = "meanR")

rownames(model.results.dt.w) <- model.results.dt.w$cell_line
model.results.dt.w$cell_line<- NULL
treatmentAnot
treatmentAnot<-treatmentAnot[!grepl("Staurosporin",treatmentAnot$treatment),]

rownames(model.results.dt.w)
treatmentAnot$treatment_type
colnames(model.results.dt.w)
treatmentAnott <- treatmentAnot[, "treatment_type", drop = F]
pdf("heatmap endpointpearsonWard.pdf", width = 10, height = 8)
aheatmap(as.matrix(t(model.results.dt.w)), Rowv = TRUE, Colv=TRUE, 
         annCol = reporterAnot, annRow = treatmentAnott,  color = my.colors,
         annColors = myColors,  fontsize = 10, width = 10, height=10, legend = TRUE,
         distfun = "pearson", hclustfun ="ward")
  
dev.off()

head(ordered.norm.my.data)
distfun = "correlation",
 hclustfun = "ward"
my.data[ rownames(my.data)=="Tacrine_80",]




getwd()


save.image("18122015.RData")

# old code starts here
#Srxn1:

AUC_Srxn1 <- read.delim(file = "/media/Image Data/POC/2012_12_06/TIFs/output/2012_12_06 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_Srxn1 <- read.delim(file = "/media/Image Data/POC/2012_12_06/TIFs/output/2012_12_06 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_Srxn1$cell <- "Srxn1"
summ_Srxn1$cell <- "Srxn1"

AUC_DDIT3 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/DDIT3/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_DDIT3 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/DDIT3/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_DDIT3$cell <- "DDIT3"
summ_DDIT3$cell <- "DDIT3"

AUC_HSPA5 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/HSPA5/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_HSPA5 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/HSPA5/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_HSPA5$cell <-"HSPA5"
summ_HSPA5$cell <- "HSPA5"

AUC_NFE2L2 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/NFE2L2/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_NFE2L2 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/NFE2L2/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_NFE2L2$cell <- "NFE2L2"
summ_NFE2L2$cell <- "NFE2L2" 

AUC_XBP1 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/XBP1/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_XBP1 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/XBP1/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_XBP1$cell<- "XBP1"
summ_XBP1$cell <-"XBP1"

AUC_ATF4 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/ATF4/2012_12_10 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_ATF4 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/ATF4/2012_12_10 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_ATF4$cell<- "ATF4"
summ_ATF4$cell <-"ATF4"

AUC_TP53 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/TP53/2012_12_10 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_TP53 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/TP53/2012_12_10 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_TP53$cell<- "TP53"
summ_TP53$cell <-"TP53"

# normalize data: scale the data according to positive control: this way the responses are scaled to each other
ind <- grep("deox" , AUC_Srxn1$treatment, ignore.case = TRUE )
AUC_Srxn1 <- AUC_Srxn1[-ind,]

ind <- grep("deox" , summ_Srxn1$treatment, ignore.case = TRUE )
summ_Srxn1[ind,]
summ_Srxn1 <- summ_Srxn1[-ind,]


#AUC_Srxn1_m <-  max(AUC_Srxn1$AUC)
#AUC_Srxn1$AUC <- AUC_Srxn1$AUC * (1 /  (100*AUC_Srxn1_m))
max(AUC_Srxn1$AUC)

ind <- grep("deox", AUC_DDIT3$treatment, ignore.case = TRUE )
AUC_DDIT3 <- AUC_DDIT3[-ind,]
#AUC_DDIT3_m <- max(AUC_DDIT3$AUC)
#AUC_DDIT3$AUC <- AUC_DDIT3$AUC * (1 / (100*AUC_DDIT3_m))
max(AUC_DDIT3$AUC)

ind <- grep("deox", AUC_HSPA5$treatment, ignore.case = TRUE )
AUC_HSPA5 <- AUC_HSPA5[-ind,]
#AUC_HSPA5_m <- max(AUC_HSPA5$AUC)
#AUC_HSPA5$AUC <- AUC_HSPA5$AUC * (1 / (100*AUC_HSPA5_m))
max(AUC_HSPA5$AUC)

ind <- grep("deox" , summ_HSPA5$treatment, ignore.case = TRUE )
summ_HSPA5[ind,]
summ_HSPA5 <- summ_HSPA5[-ind,]




ind <- grep("deox", AUC_NFE2L2$treatment, ignore.case = TRUE )
AUC_NFE2L2 <- AUC_NFE2L2[-ind,]
#AUC_NFE2L2_m <- max(AUC_NFE2L2$AUC)
#AUC_NFE2L2$AUC <- AUC_NFE2L2$AUC * (1 / (100*AUC_NFE2L2_m))
max(AUC_NFE2L2$AUC)

ind <- grep("deox", AUC_XBP1$treatment, ignore.case = TRUE )
AUC_XBP1 <- AUC_XBP1[-ind,]
#AUC_XBP1_m <- max(AUC_XBP1$AUC)
#AUC_XBP1$AUC <- AUC_XBP1$AUC * (1 / (100*AUC_XBP1_m))
max(AUC_XBP1$AUC)

ind <- grep("deox", AUC_ATF4$treatment, ignore.case = TRUE )
AUC_ATF4 <- AUC_ATF4[-ind,]
#AUC_ATF4_m <- max(AUC_ATF4$AUC)
#AUC_ATF4$AUC <- AUC_ATF4$AUC * (1 / (100*AUC_ATF4_m))
max(AUC_ATF4$AUC)

ind <- grep("deox", AUC_TP53$treatment, ignore.case = TRUE )
AUC_TP53 <- AUC_TP53[-ind,]
#AUC_TP53_m <- max(AUC_TP53$AUC)
#AUC_TP53$AUC <- AUC_TP53$AUC * (1 / (100*AUC_TP53_m))
max(AUC_TP53$AUC)

ind <- grep("deox" , summ_TP53$treatment, ignore.case = TRUE )
summ_TP53[ind,]
summ_TP53 <- summ_TP53[-ind,]



# plot heatmap
myData_AUC <- rbind(AUC_Srxn1, AUC_DDIT3, AUC_HSPA5, AUC_NFE2L2, AUC_XBP1, AUC_ATF4, AUC_TP53)

colnames(summ_Srxn1)[5] <-"Intensity"
colnames(summ_HSPA5)[5] <-"Intensity"
colnames(summ_TP53)[5] <-"Intensity"
myData_summ <- rbind( summ_Srxn1, summ_HSPA5, summ_TP53)
head(myData_summ)
colnames(myData_summ)[6] <- "Cell_Line"

colnames(myData_AUC)[3] <- "Cell_Line"
# myData_AUC$Stress_Response <- NA
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "TP53"] <- "DDR"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "Srxn1"] <- "OS"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "NFE2L2"] <- "OS"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "DDIT3"] <- "ER-stress"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "HSPA5"] <- "ER-stress"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "XBP1"] <- "ER-stress"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "ATF4"] <- "ER-stress"


myData_AUC$Compound_Type <- NA
myComps<-unique(myData_AUC$treatment)
myComps
ind <- grep( "CDDO" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "DEM" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "IAA" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "menadio" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "H2O2" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"


ind <- grep( "BFA" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "ER-stress"
ind <- grep( "tunica" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "ER-stress"
ind <- grep( "thapsi" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "ER-stress"

ind <- grep( "cispl" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "DDR"
ind <- grep( "etop" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "DDR"

ind <- grep( "DMSO" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "vehicle"



myData_AUC$Compound_Type[is.na(myData_AUC$Compound_Type)] <- "other"

myData_AUC$Compound_Type <- factor(myData_AUC$Compound_Type)
 


head(myData_AUC)

myData_AUC <- myData_AUC[ myData_AUC$treatment != "Menadione H", ]
myData_AUC <- myData_AUC[ myData_AUC$treatment != "Menadione M", ]
myData_AUC <- myData_AUC[ myData_AUC$treatment != "DMSO 75 %", ]

myData_summ <- myData_summ[ myData_summ$treatment != "Menadione H", ]
myData_summ <- myData_summ[ myData_summ$treatment != "Menadione M", ]
myData_summ <- myData_summ[ myData_summ$treatment != "DMSO 75 %", ]




AUC_Srxn1
AUC_DDIT3
AUC_HSPA5
AUC_NFE2L2
AUC_XBP1
AUC_ATF4
AUC_TP53
Srxn1 <- myData_AUC[ myData_AUC$Cell_Line=="Srxn1", c("treatment","AUC")]
DDIT3 <- myData_AUC[ myData_AUC$Cell_Line=="DDIT3", c("treatment","AUC")]
HSPA5 <- myData_AUC[ myData_AUC$Cell_Line=="HSPA5", c("treatment","AUC")]
NFE2L2 <- myData_AUC[ myData_AUC$Cell_Line=="NFE2L2", c("treatment","AUC")]
XBP1 <- myData_AUC[ myData_AUC$Cell_Line=="XBP1", c("treatment","AUC")]
ATF4 <- myData_AUC[ myData_AUC$Cell_Line=="ATF4", c("treatment","AUC")]
TP53 <- myData_AUC[ myData_AUC$Cell_Line=="TP53", c("treatment","AUC")]

myData_AUC_q <- cbind(Srxn1, DDIT3, HSPA5, NFE2L2, XBP1, ATF4, TP53)

rownames(myData_AUC_q) <- myData_AUC_q[,13]
myData_AUC_q <- myData_AUC_q[,-c(1,3,5,7,9,11,13)] 
colnames(myData_AUC_q ) <- c("Srxn1", "DDIT3", "HSPA5", "NFE2L2", "XBP1", "ATF4", "TP53")




Compound_Type <- c( "darkred", "limegreen", "blue", "pink", "lightblue")
names(Compound_Type) <- c("DDR", "ER-stress", "OS", "other", "vehicle")
myColors <- list(Compound_Type = Compound_Type)

zehDist <- c("manhattan","correlation", "euclidean")[3]
zehClust <- c("single" , "average", "ward", "complete", "centroid")[2]

 means.col <-  unlist(lapply(myData_AUC_q,  mean ))
  means.sd <-  unlist(lapply(myData_AUC_q,  sd ))
myData_AUC_q_n <-myData_AUC_q
head(myData_AUC_q_n)
myData_AUC_q_n$Srxn1 <-  (myData_AUC_q$Srxn1 - as.numeric(means.col["Srxn1"]) )/ as.numeric(means.sd["Srxn1"])
myData_AUC_q_n$DDIT3 <-  (myData_AUC_q$DDIT3 - means.col["DDIT3"]) / means.sd["DDIT3"]
myData_AUC_q_n$HSPA5 <-  (myData_AUC_q$HSPA5 - means.col["HSPA5"]) / means.sd["HSPA5"]
myData_AUC_q_n$NFE2L2 <-  (myData_AUC_q$NFE2L2 - means.col["NFE2L2"]) / means.sd["NFE2L2"]
myData_AUC_q_n$XBP1 <-  (myData_AUC_q$XBP1 - means.col["XBP1"]) / means.sd["XBP1"]
myData_AUC_q_n$ATF4 <-  (myData_AUC_q$ATF4 - means.col["ATF4"]) / means.sd["ATF4"]
myData_AUC_q_n$TP53 <-  (myData_AUC_q$TP53 - means.col["TP53"]) / means.sd["TP53"]



head(myData_AUC_q_n)



min(myData_AUC_q_n)

hmcols<-colorRampPalette(c("white","blue"))(256)

white <- hmcols[1]
lightestBlue <-hmcols[30]
lightBlue <- hmcols[80]
blue <- hmcols[128]
darkBlue <- hmcols[156]
darkerBlue <- hmcols[180]
darkestBlue <-hmcols[256]

my.seq<-seq(min(myData_AUC_q_n),max(myData_AUC_q_n), length.out=8)

Breakwhite <- my.seq[2]
BreaklightestBlue <- my.seq[3]
BreaklightBlue<- my.seq[4]
Breakblue <-  my.seq[5]
BreakdarkBlue <- my.seq[6]
BreakdarkerBlue <- my.seq[7]
BreakdArkestBlue <- my.seq[8]



  myBreaks <-c( Breakwhite, BreaklightestBlue, BreaklightBlue, Breakblue, BreakdarkBlue, BreakdarkerBlue, BreakdArkestBlue) 


color_palette <- c(white, lightestBlue, lightBlue, blue, darkBlue, darkerBlue, darkestBlue)

# set up myAnot data and quantitative data



head(myData_AUC)
myAnot <- data.frame( treatment = myData_AUC$treatment[ myData_AUC$Cell_Line=="TP53"], Compound_Type = myData_AUC$Compound_Type[ myData_AUC$Cell_Line == "TP53"  ])
rownames(myAnot) <- myAnot$treatment
myAnot$treatment <- NULL
head(myAnot)

sum(rownames(myAnot) != rownames(myData_AUC_q))

fontsize_row = 8; fontsize_col = 6;
pheatmap(t(as.matrix(myData_AUC_q_n)), col= color_palette, breaks =  myBreaks , main= "Specificity of Adaptive stress response Reporters",  
         fontsize_row=fontsize_row, fontsize_col =fontsize_col, border_color=NA, scale = "row",
         cluster_rows = TRUE, cluster_cols = TRUE, clustering_distance_rows = zehDist, 
         clustering_method = zehClust,  
          legend = TRUE, fontsize = 4,
          legend_breaks = round(myBreaks, digits=1), 
         annotation = myAnot, annotation_colors = myColors,
          display_numbers = F )






  
  
  #plot xy plots overlayed
head(myData_summ)
sum.means <- ddply(myData_summ, .(Cell_Line), function(x) mean(x$Intensity))
sum.sd <- ddply(myData_summ, .(Cell_Line), function(x) sd(x$Intensity))

myData_summ$Intensity[ myData_summ$Cell_Line=="Srxn1"] <- (myData_summ$Intensity[ myData_summ$Cell_Line=="Srxn1"] -
  sum.means$V1[ sum.means$Cell_Line == "Srxn1"]) /  sum.sd$V1[ sum.sd$Cell_Line == "Srxn1"]

myData_summ$Intensity[ myData_summ$Cell_Line=="HSPA5"] <- (myData_summ$Intensity[ myData_summ$Cell_Line=="HSPA5"] -
  sum.means$V1[ sum.means$Cell_Line == "HSPA5"]) /  sum.sd$V1[ sum.sd$Cell_Line == "HSPA5"]

myData_summ$Intensity[ myData_summ$Cell_Line=="TP53"] <- (myData_summ$Intensity[ myData_summ$Cell_Line=="TP53"] -
  sum.means$V1[ sum.means$Cell_Line == "TP53"]) /  sum.sd$V1[ sum.sd$Cell_Line == "TP53"]

#tijd van HSPA5 klopt niet
myData_summ$timeAfterExposure[ myData_summ$Cell_Line=="HSPA5"] <- myData_summ$timeAfterExposure[ myData_summ$Cell_Line=="HSPA5"] / 2

unique(myData_summ$treatment)

p<- ggplot( data = myData_summ, group = Cell_Line,  aes( x = timeAfterExposure , y = Intensity,  linetype = "Cell_Line", color = Cell_Line)) + geom_point(symbol =".", size = 1 ) 

p <- p + facet_wrap(~ treatment )
p <- p + theme( axis.text.x = element_text(angle = 90, hjust = 1, size = 14, colour = "grey50") ) + 
theme( strip.text.x = element_text( size = 14)) 
 p 
 











```