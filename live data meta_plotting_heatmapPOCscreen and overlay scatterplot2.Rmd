

# statistiek doen voor replicate figuren

figures for POC paper

```{r}
rm(list=ls())
setwd("E:/bckup 20 febr 2015/POC meta analyse/full")

require(ggplot2)
require(NMF)
require(stringr)
require(data.table)
require(grid)

source("C:\\Users\\steve_000\\Documents\\H5CellProfiler\\H5CellProfiler\\theme_sharp.R")

options(stringsAsFactors=FALSE)
all.files <- dir("summary files")

all.paths <- as.list(paste("summary files", all.files, sep = "/"))

cellineStr<-lapply(all.paths, str_match,"( [A-Z a-z 0-9]{3,15}).txt")

cellineStr<-lapply(cellineStr, "[[",2)
cellineStr <- lapply(cellineStr, gsub, pattern=' ', replacement='')

plateStr <- lapply(all.paths, str_match, "[0-9]{4}_[0-9]{2}_[0-9]{2} myData_summarized[ A-Z a-z 0-9 _ -]{1,28}.txt")
plateStr<- lapply(plateStr, gsub, pattern ='.txt' , replacement ='')
plateStr<- lapply(plateStr, gsub, pattern =' myData_summarized' , replacement ='')

names(all.paths)<-plateStr


# read in data:
data.raw=list()
  for(i in seq_along(all.paths)){
    print(i)
    data.raw[[i]] <- fread(all.paths[[i]], sep ="\t", header = TRUE)
    data.raw[[i]][,V1:=NULL]
    }
#verify cell line inside and out
for( i in seq_along(all.paths)){
print(i)
  print(paste(all.paths[i],unique(data.raw[[i]]$cell_line), sep ="___"))
print(cellineStr[i])
}

# fix all inconsistancies accros datasets.
   # fix cell line names:
for( i in seq_along(data.raw)){
  data.raw[[i]]$cell_line <- cellineStr[i]
}

# fix / standardize all compound names & remove compounds not of interest:

all.comps<- lapply(data.raw, "[[", "treatment")
all.comps<-unlist(all.comps)
all.comps<- unique(all.comps)
comps.keep<- c("BFA","CCCP", "CDDO","Cisplatin","DEM","DMEM","DMSO 25%","DMSO 50%",
               "DMSO 75%","DMSO max","Etoposide","H2O2","Iodoacetamide","Menadione","Nocodazole","Oligomycin B",
               "Thapsigargin","Tunicamycin","DMSO","Staurosporin","DMSO 100%","IAA", "Chlorpromazine","DMNQ")
length(comps.keep)
data.raw.t<- lapply(data.raw, function(x) {x<-x[ treatment %in% comps.keep,] })

lapply(data.raw.t, function(x) unique(x$treatment))

all.comps<- lapply(data.raw.t, "[[", "treatment")
all.comps<-unlist(all.comps)
all.comps<- unique(all.comps)

data.raw<-data.raw.t
data.raw.t<- lapply(data.raw, function(x){ 
   x[ ,treatment:= gsub("Iodoacetamide", "IAA",treatment)]})
data.raw<-data.raw.t
# fix DMSO

# fix feature data
all.feats <- unique(unlist(lapply(data.raw,"[[","variable")))
#data.raw
names(data.raw[[71]])

setnames(data.raw[[71]], "Cells_Children_obj_foci_Count", "value")
data.raw[[71]]$variable <- "Cells_Children_obj_foci_Count"

setnames(data.raw[[74]], "Cells_Children_obj_foci_Count", "value")
data.raw[[74]]$variable <- "Cells_Children_obj_foci_Count"

all.feats <- unique(unlist(lapply(data.raw,"[[","variable")))


# [1] "Cytoplasm_Intensity_MeanIntensity_img_gfp"                               "Cytoplasm_Intensity_IntegratedIntensity_img_gfp"                        
#  [3] "Nuclei_AreaShape_Area"                                                   "Nuclei_Intensity_MeanIntensity_img_hoechst"                             
#  [5] "Displacement"                                                            "imageCountTracked"                                                      
#  [7] "Nuclei_Intensity_MeanIntensity_img_gfp"                                  "Nuclei_Intensity_IntegratedIntensity_img_gfp"                           
#  [9] "obj_nc_Intensity_MeanIntensity_img_cyto"                                 "obj_nc_Intensity_IntegratedIntensity_img_cyto"                          
# [11] "obj_nc_AreaShape_Area"                                                   "obj_nc_Intensity_MeanIntensity_img_nc"                                  
# [13] "obj_nc_Intensity_MeanIntensity_gfp_img"                                  "obj_nc_Intensity_IntegratedIntensity_gfp_img"                           
# [15] "obj_nc_Intensity_MeanIntensity_nc_image"                                 "Cytoplasm_Intensity_MeanIntensity_gfp_img"                              
# [17] "Cytoplasm_Intensity_IntegratedIntensity_gfp_img"                         "obj_cyto_only_Intensity_MeanIntensity_img_cyto"                         
# [19] "obj_cyto_only_Intensity_IntegratedIntensity_img_cyto"                    "Cytoplasm_Intensity_MeanIntensity_img_cyto"                             
# [21] "Cyto_only_Intensity_MeanIntensity_img_cyto"                              "obj_nc_Children_filtered_foci_Count"                                    
# [23] "obj_nc_Intensity_MeanIntensity_img_gfp"                                  "filtered_foci_AreaShape_Area"                                           
# [25] "filtered_foci_Intensity_MeanIntensity_img_gfp"                           "Image_AreaOccupied_AreaOccupied_filtered_foci"                          
# [27] "count_obj_cyto_only_Intensity_IntegratedIntensity_img_cyto_larger_1.606" "count_obj_cyto_only_Intensity_IntegratedIntensity_img_cyto_larger_2.409"
# [29] "obj_nc_TrackObjects_DistanceTraveled_30"                                 "obj_foci_Intensity_MeanIntensity_img_gfp"                               
# [31] "obj_foci_AreaShape_Area"                                                 "obj_nc_Children_obj_foci_Count"                                         
# [33] "obj_nc_TrackObjects_DistanceTraveled_80"                                 "Cells_Children_obj_foci_Count"                                          
# [35] "obj_nc_Intensity_IntegratedIntensity_img_gfp"                           

  
convertToo1<- "Cytoplasm_Intensity_MeanIntensity_img_gfp"  
convert1 <- c("Cytoplasm_Intensity_MeanIntensity_gfp_img", "obj_cyto_only_Intensity_MeanIntensity_img_cyto", "Cytoplasm_Intensity_MeanIntensity_img_cyto","Cyto_only_Intensity_MeanIntensity_img_cyto")
convertToo2 <- "Cytoplasm_Intensity_IntegratedIntensity_img_gfp"
convert2<- c("Cytoplasm_Intensity_IntegratedIntensity_gfp_img", "obj_cyto_only_Intensity_IntegratedIntensity_img_cyto")
convertToo3 <- "Nuclei_AreaShape_Area"
convert3<- "obj_nc_AreaShape_Area"
convertToo4<-  "Nuclei_Intensity_MeanIntensity_img_hoechst"
convert4<- c("obj_nc_Intensity_MeanIntensity_img_nc", "obj_nc_Intensity_MeanIntensity_nc_image")
convertToo5 <- "Displacement"
convert5 <- c("obj_nc_TrackObjects_DistanceTraveled_30", "obj_nc_TrackObjects_DistanceTraveled_80")
convertToo6<- "imageCountTracked"
#convert6
convertToo7 <- "Nuclei_Intensity_MeanIntensity_img_gfp"
convert7<- c("obj_nc_Intensity_MeanIntensity_img_cyto", "obj_nc_Intensity_MeanIntensity_gfp_img","obj_nc_Intensity_MeanIntensity_img_gfp")   

convertToo8<- "Foci_Count"
convert8 <- c("obj_nc_Children_filtered_foci_Count", "obj_nc_Children_obj_foci_Count", "Cells_Children_obj_foci_Count")

convertToo9<- "filtered_foci_AreaShape_Area"
convertToo10<- "filtered_foci_Intensity_MeanIntensity_img_gfp"
convertToo11<- "Image_AreaOccupied_AreaOccupied_filtered_foci"
convertToo12<- "Cells_Children_filtered_foci_Count"

convertToo13 <- "Nuclei_Intensity_IntegratedIntensity_img_gfp"
convert13 <- c("obj_nc_Intensity_IntegratedIntensity_img_gfp", "obj_nc_Intensity_IntegratedIntensity_img_cyto", "obj_nc_Intensity_IntegratedIntensity_gfp_img")
keep<-c(convertToo1,convertToo2,convertToo3,convertToo4,convertToo5,convertToo6,convertToo7,
        convertToo8,convertToo9,convertToo10,convertToo11,convertToo12,convertToo13)
  
data.rawBKUP <- data.raw



for( i in seq_along(data.raw)){
  if( "value" %in% names(data.raw[[i]]) ) {
  setnames(data.raw[[i]], "value", "meanSummaryStat")
  } 
  
}

#data.raw 
# conversions:  
  lapply(data.raw, names)

for( i in seq_along(convert1)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert1[i], convertToo1,variable)]
  })
  }  
  
for( i in seq_along(convert2)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert2[i], convertToo2,variable)]
  })
  } 
for( i in seq_along(convert3)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert3[i], convertToo3,variable)]
  })
  } 
for( i in seq_along(convert4)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert4[i], convertToo4,variable)]
  })
  } 
for( i in seq_along(convert4)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert5[i], convertToo5,variable)]
  })
  }
for( i in seq_along(convert7)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert7[i], convertToo7,variable)]
  })
  } 
for( i in seq_along(convert8)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert8[i], convertToo8,variable)]
  })
  } 
for( i in seq_along(convert8)){
  data.raw<-lapply( data.raw, function(x) {
  x[, variable:= gsub(convert13[i], convertToo13,variable)]
  })
  } 

  data.raw<-lapply(data.raw, function(x){x<-x[variable%in%keep] })

which(unlist(lapply( data.raw, function(x) "allVarCells" %in% names(x))))
data.raw[[60]]$allVarCells <- NULL

lapply(data.raw, length)

unique(lapply(data.raw1, names))


for(i in seq_along(data.raw)){
data.raw[[i]]$plateID <- plateStr[i]
  
}

data.raw1 <- lapply(data.raw, function(x) x<-x[, n:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, error95:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, sd:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, doseLevel:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, timeID:=NULL] )
data.raw1 <- lapply(data.raw1, function(x) x<-x[, control:=NULL] )
data.raw <- data.raw1

coln <- c("treatment" ,        "dose_uM"   ,        "timeAfterExposure" ,"control"      ,     "cell_line"       ,  "variable"     ,     "meanSummaryStat"  , "plateID")       
which(!unlist(lapply(data.raw, function(x) all(  names(x) %in% coln ))))



data.raw.dt<- do.call("rbind", data.raw)



#data.raw.dt[ treatment %in% "DMSO" , meanPlateDMSO := mean( meanSummaryStat, na.rm = TRUE ) , by = list(treatment, cell_line, timeAfterExposure, plateID) ]

data.raw.dt[, minmaxNorm:= (meanSummaryStat - min(meanSummaryStat,na.rm=TRUE))/ 
              (max(meanSummaryStat, na.rm=TRUE) - min(meanSummaryStat,na.rm=TRUE)),
            by= list(plateID, variable)]



unique(data.raw.dt[, plateID])

data.raw.dt[,timeAfterExposure:= as.numeric(timeAfterExposure)]

all.treats<-unique(data.raw.dt[,treatment])
data.raw.dt[, treatment:= gsub("DMSO 25%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO 50%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO 75%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO 100%", "DMSO", treatment)]
data.raw.dt[, treatment:= gsub("DMSO max", "DMSO", treatment)]

head(data.raw.dt)
data.raw.dt[ data.raw.dt$treatment == "Menadione" & data.raw.dt$dose_uM == "2.5", "dose_uM"] <- "5"
data.raw.dt[ data.raw.dt$treatment == "CDDO" & data.raw.dt$dose_uM == "0.05", "dose_uM"] <- "0.03"
data.raw.dt[ data.raw.dt$treatment == "CDDO" & data.raw.dt$dose_uM == "0.025", "dose_uM"] <- "0.015"
data.raw.dt[ data.raw.dt$treatment == "CDDO" & data.raw.dt$dose_uM == "0.0125", "dose_uM"] <- "0.0075"
unique(data.raw.dt$treatment)
data.raw.dt<- data.raw.dt[!treatment %in% c("CCCP", "Nocodazole", "Oligomycin B", "Staurosporin", "Chlorpromazine", "DMNQ", "Menadione")  ,] # including starosporin here
dim(data.raw.dt)
# generate figure 1 (heatmap) (based on mean values for now, # of cells above bckgr is next step)


minmaxFun <- function(x) { 
                          min_e = min(x, na.rm = TRUE)
                          max_e = max(x, na.rm = TRUE)
                          y <- (x - min_e) / (max_e - min_e)
                          y
                          }

# select data
selPlateIDs <- c("2013_01_16 HSPA5",  "2013_01_31 HSPA5", "2013_02_06 HSPA5", #1
 "2014_06_27 NFE2L2", "2014_06_30 NFE2L2", "2014_07_03 NFE2L2", #4
 "2013_01_16 XBP1",  "2013_02_06 XBP1", #7
  "2013_01_16 DDIT3", "2013_03_13 DDIT3", "2013_03_20 DDIT3", #9
   "2012_12_10 ATF4", "2012_12_14 ATF4", "2012_12_19 ATF4", #12
	"2012_12_10 TP53", "2012_12_14 TP53",	   "2012_12_19 TP53", #15
 "2013_03_13 SRXN1",    "2013_03_20 SRXN1", 	"2013_02_27 SRXN1", #18
 "2013_10_10 KEAP1",   "2013_10_16 KEAP1", 	"2013_10_30 KEAP1", #21
  "2013_03_20 TP53BP1",   "2014_06_30 TP53BP1",	 "2014_07_03 TP53BP1", #24
  "2013_10_10 BTG2", "2013_10_16 BTG2",	"2013_10_30 BTG2", #27
  "2013_10_10 p21", "2013_10_16 p21", "2013_10_30 p21") #30
selPlateIDs<- unique(selPlateIDs)
length(selPlateIDs)
my.data <- data.raw.dt[ plateID %in% selPlateIDs,]
length(unique(my.data$plateID))
which(!selPlateIDs %in% my.data$plateID)

# assign replID
(my.data[, replID])

reps1 <- c(1,4,7,9,12,15,18,21,24,27,30)
repl.1_plates <- selPlateIDs[reps1]
repl.2_plates <- selPlateIDs[reps1+1]
reps3 <- reps1+2
reps3[3]<-8
repl.3_plates<-selPlateIDs[reps3]
my.data[ plateID %in% repl.1_plates  , replID:= "repl.1"]
my.data[ plateID %in% repl.2_plates  , replID:= "repl.2"]
my.data[ plateID %in% repl.3_plates  , replID:= "repl.3"]
sum(is.na(my.data[, replID]))


unique(my.data$variable)
#select the response data
my.data[, cell_line.var := paste(cell_line, variable)]
my.data[, treat.dose := paste(treatment, dose_uM)]
unique(my.data[,cell_line.var])
sel.c <- c("ATF4 Nuclei_Intensity_MeanIntensity_img_gfp","BTG2 Cytoplasm_Intensity_IntegratedIntensity_img_gfp",
           "DDIT3 Nuclei_Intensity_MeanIntensity_img_gfp", "HSPA5 Cytoplasm_Intensity_IntegratedIntensity_img_gfp",
           "KEAP1 Foci_Count", "NFE2L2 Nuclei_Intensity_MeanIntensity_img_gfp", 
           "SRXN1 Cytoplasm_Intensity_IntegratedIntensity_img_gfp", "TP53 Nuclei_Intensity_MeanIntensity_img_gfp",
           "TP53BP1 Foci_Count",
           "XBP1 Nuclei_Intensity_MeanIntensity_img_gfp", "p21 Nuclei_Intensity_MeanIntensity_img_gfp")



my.data.response <- my.data[ cell_line.var %in% sel.c ,]
dim(my.data.response)
head(my.data.response)
# must have 3 plates per readout except for XBP1 which has 2 readouts:
my.data.response$cellSpecReadoutPlate <- paste(my.data.response$cell_line.var, my.data.response$plateID, sep ="_")
unique(my.data.response$cellSpecReadoutPlate)
(11*3-1) == length(unique(my.data.response$cellSpecReadoutPlate))
unique(my.data.response$treatment)
my.data.response[, minmaxNorm:=NULL]

# first subtract DMSO background on per-timepoint base, before using the scaling... (the replicates were too systematically different between plates without DMSO subtraction)
#DMSO background is per-cell line-per-plate basis
?split
unique( my.data.response$plateID)

DMSO.mean <- my.data.response[ treatment %in% "DMSO", 
                                mean(meanSummaryStat, na.rm= TRUE),
                               by = c("plateID", "cell_line", "variable", "timeAfterExposure")]


setnames(DMSO.mean, old = "V1", new = "DMSO.mean")
setkeyv(DMSO.mean, c("plateID", "cell_line", "variable", "timeAfterExposure"))
setkeyv(my.data.response, c("plateID", "cell_line", "variable", "timeAfterExposure"))

my.data.response<-my.data.response[DMSO.mean]


# for which variables does subtracting DMSO make sense? try all
unique(my.data.response$variable)

my.data.response[, DMSO.sub.Value:= meanSummaryStat - DMSO.mean]





###

my.data.response[, minmaxNorm:= minmaxFun(DMSO.sub.Value), by= list(cell_line, plateID) ]

plot(density(my.data.response[ replID == "repl.2", minmaxNorm]))

my.data.response[, minmaxNorm:= (DMSO.sub.Value - min(DMSO.sub.Value,na.rm=TRUE))/ 
              (max(DMSO.sub.Value, na.rm=TRUE) - min(DMSO.sub.Value,na.rm=TRUE)),
            by= list(plateID, variable, cell_line)]




#collapse time, choose 1 before last tp. remove last point, then choose max point

head(my.data.response)

unique(my.data.response[, dose_uM])

my.data.response[, dose_uM:= gsub(8.925, 9, dose_uM)]
my.data.response[, dose_uM:= gsub(17.85, 18, dose_uM)]
my.data.response[, dose_uM:= gsub(35.7, 36, dose_uM)]
my.data.response[, dose_uM:= gsub(0.0075, 0.008, dose_uM)]
my.data.response[, dose_uM:= gsub(6.25, 6, dose_uM)]
my.data.response[, dose_uM:= gsub(2.975, 3, dose_uM)]
my.data.response[, dose_uM:= gsub(5.95, 6, dose_uM)]
my.data.response[, dose_uM:= gsub(11.9, 12, dose_uM)]


# calculate mean  of replicates
unique(my.data.response$timeAfterExposure)
my.data.response[, treat.dose:= paste(treatment, dose_uM)]
# first plot replicates to check out data

unique(my.data.response[,treatment])
my.data.response <- my.data.response[!treatment %in% "H2O2"]
unique(my.data.response[, cell_line])
my.data.response[, cell_line := gsub("HSPA5" ,"BiP" , cell_line)]
my.data.response[, cell_line := gsub("NFE2L2" , "Nrf2", cell_line)]
my.data.response[, cell_line := gsub("XBP1" , "Xbp1", cell_line)]
my.data.response[, cell_line := gsub("DDIT3" , "CHOP", cell_line)]
my.data.response[, cell_line := gsub("ATF4" , "Atf4", cell_line)]
my.data.response[, cell_line := gsub("TP53" , "p53", cell_line)]
my.data.response[, cell_line := gsub("SRXN1" , "Srxn1", cell_line)]
my.data.response[, cell_line := gsub("KEAP1" , "Keap1", cell_line)]
my.data.response[, cell_line := gsub("TP53BP1" ,"tp53bp1" , cell_line)]
my.data.response[, cell_line := gsub("BTG2" , "Btg2", cell_line)]



p<-ggplot( my.data.response, aes(x=timeAfterExposure, y = minmaxNorm, color = replID)) +
  geom_point(aes(group = replID )) + theme_sharp()


p <- p + facet_grid( treat.dose~cell_line) 
p 


require(splines)
require(stats); require(graphics)

# loop over each cell line treatment dose combination for b-spline model. store and plot for qc. use model data for plotting means and for heatmap

unique(my.data.response[, list(variable, cell_line)])

my.data.response$splitL <- paste(my.data.response$cell_line , my.data.response$treatment, my.data.response$dose_uM,my.data.response$replID )
my.data.response.list <- split(my.data.response, c(my.data.response$splitL))

model.results = list()
zeh.path <- "C:/Users/steve_000/Documents/work/POC paper"
dir.create("C:/Users/steve_000/Documents/work/POC paper/model fit graphs")
# default: df 6 range 0,24

#pdf(file = paste(zeh.path,"/model fit graphs/model fit graphs_overfit.pdf", sep =""), height = 6, width = 6)
for( i in seq_along(my.data.response.list)){
  
  fm1 <- lm(minmaxNorm ~ ns(timeAfterExposure, df =6), data = my.data.response.list[[i]])
  
    model.results[[i]] <-  predict(fm1, dtTime<-data.frame(
    
    timeAfterExposure = round(seq(0, 24, length.out=200), digits=2))) # variabele tijd.
    model.results[[i]] <- as.data.frame(model.results[[i]] )
    colnames(model.results[[i]])<- "mod"
   
    model.results[[i]]$cell_line <- unique(my.data.response.list[[i]]$cell_line)  
    model.results[[i]]$treatment <- unique(my.data.response.list[[i]]$treatment)
    model.results[[i]]$dose_uM <- unique(my.data.response.list[[i]]$dose_uM)
    model.results[[i]]$replID <- unique(my.data.response.list[[i]]$replID)
    model.results[[i]]$timeAfterExposure <- dtTime$timeAfterExposure
    model.results[[i]]$resid.SD <- sqrt(deviance(fm1)/df.residual(fm1))# residual standard error, as a means to capture variability of datapoints
    
    
    
     # p <- ggplot(data =  model.results[[i]], aes(x=timeAfterExposure, y = mod)) + geom_point() + 
    #      geom_point(data= my.data.response.list[[i]], aes(x=timeAfterExposure, y = minmaxNorm, color = replID)) + 
   # ggtitle(unique(my.data.response.list[[i]]$splitL)) + ylim(c(0,1))
  
  #print(p)

}
dev.off()

# getwd()


#save.image(paste(zeh.path, "/freeze10mei2016.RData", sep = ""))

#load(paste(zeh.path, "/freeze10mei2016.RData", sep = ""))

my.data.response[, max(timeAfterExposure), by = plateID]


head(model.results[[3]])
model.results.df <- do.call("rbind", model.results)
head(model.results.df)
require(plyr)


unique(model.results.df$treatment)
model.results.df <- as.data.table(model.results.df)
# NFE2L2  IAA

table(model.results.df[ treatment %in% "DMSO", list( dose_uM, replID) ])

testStats <- model.results.df[ treatment %in% "BFA" & cell_line %in% "Btg2" & dose_uM %in% 9 , ]

DMSO_low <- model.results.df[ treatment %in% "DMSO" & cell_line %in% "Btg2" & dose_uM %in% 25 , ]
DMSO_low2 <- model.results.df[ treatment %in% "DMSO" & cell_line %in% "Nrf2" & dose_uM %in% 50 , ]
DMSO_low2[, replID:=gsub("repl.1", "repl.4", replID)]
DMSO_low2[, replID:=gsub("repl.2", "repl.5", replID)]
DMSO_low2[, replID:=gsub("repl.3", "repl.6", replID)]
DMSO_low<- rbind(DMSO_low,DMSO_low2)
unique(DMSO_low$dose_uM)

# down sample time points:

selTP <- unique(DMSO_low[, timeAfterExposure])[seq(1,  200, by = 9)]
DMSO_low <- DMSO_low[ timeAfterExposure %in% selTP ]
testStats_low <- testStats[ timeAfterExposure %in% selTP]
Low <- rbind(DMSO_low, testStats_low)



# calculate mean of DMSO and sd of DMSO 
DMSO_summary <- DMSO_low[ , list( Mean = mean(mod), Sd = sd(mod)), by = list(cell_line, treatment, timeAfterExposure)]

setkey(Low, cell_line, timeAfterExposure)
setkey(DMSO_summary, cell_line, timeAfterExposure)

testStats_low.w <- DMSO_summary[ Low ]
any(is.na(testStats_low.w))

# calculate sd-normalized difference, corrected for biased mean of DMSO's
Correction = 3/2 # 1 less df for DMSO
testStats_low.w[ , meanDiff := abs( mod - Mean ) / Sd * Correction ] # alleen test voor positief...
# calculate mean difference over time:
testStats_low.w.m <- testStats_low.w[, mean(meanDiff), by = list( cell_line, i.treatment, replID  )]

model1 <- lm(V1 ~ i.treatment, data = testStats_low.w.m)
ggplot( data = Low, aes(x=timeAfterExposure, y = mod, group = replID))  + geom_point(aes(color = treatment, shape = replID)) 

ggplot( data = testStats_low.w, aes( x = timeAfterExposure, y = meanDiff, group = replID   )) + geom_point( aes(color = i.treatment))
 
summary(model1)


# eerst voor 1tje proberen
# dan code voor allemaal
head(model.results.df)

# downsample for stats
selTP <- unique(model.results.df[, timeAfterExposure])[seq(1,  200, by = 9)]
selTP <- selTP[ selTP < 11 ]
model.results.df <- model.results.df[ timeAfterExposure %in% selTP]
model.results.df$dose_uM <- as.numeric(model.results.df$dose_uM)  
model.results.df <- as.data.frame(model.results.df)
model.results.df <- model.results.df[  order( model.results.df[ , "replID"],
                                              model.results.df[ , "cell_line"],
                                              model.results.df[ , "treatment"],
                                              model.results.df[ , "dose_uM"]),   ]
  head(model.results.df)
counts.d <- ddply(model.results.df, .(replID, cell_line, treatment,timeAfterExposure ), summarize,count.d.l = length(dose_uM))


head(counts.d)

model.results.df$dose.f <- NA
for (i in 1 : nrow(counts.d))
{
  
  model.results.df$dose.f[ model.results.df$replID == counts.d$replID[i] & 
                           model.results.df$treatment == counts.d$treatment[i] & 
                           model.results.df$timeAfterExposure == counts.d$timeAfterExposure[i] &
                           model.results.df$cell_line == counts.d$cell_line[i]] <- gl(counts.d$count.d.l[i], 1)
  
}


# per dose.f, match 1 DMSO
testStats <- model.results.df[ treatment %in% "IAA" & cell_line %in% "Nrf2" & dose_uM %in% 5 , ]
DMSO_low <- model.results.df[ treatment %in% "DMSO" & cell_line %in% "Nrf2" & dose_uM %in% 25 , ]

unique(DMSO_low$dose_uM)

# down sample time points:

# == calculate mean of DMSO and sd of DMSO 
model.results.df <- as.data.table( model.results.df)

# calculate sd of response. needed to normalize the differences of the responses
model.results.df.sd <- model.results.df[ , sd( mod ), by = list( cell_line, treatment , dose.f ,timeAfterExposure)]
setnames(model.results.df.sd, "V1", "treat.sd")

DMSO <- model.results.df[ treatment %in% "DMSO"]
# 
DMSO[dose.f == 2, replID := gsub( "repl.1", "repl.4", replID)  ]
DMSO[dose.f == 2, replID := gsub( "repl.2", "repl.5", replID)  ]
DMSO[dose.f == 2, replID := gsub( "repl.3", "repl.6", replID)  ]

DMSO[dose.f == 3, replID := gsub( "repl.1", "repl.7", replID)  ]
DMSO[dose.f == 3, replID := gsub( "repl.2", "repl.8", replID)  ]
DMSO[dose.f == 3, replID := gsub( "repl.3", "repl.9", replID)  ]

DMSO[dose.f == 4, replID := gsub( "repl.1", "repl.10", replID)  ]
DMSO[dose.f == 4, replID := gsub( "repl.2", "repl.11", replID)  ]
DMSO[dose.f == 4, replID := gsub( "repl.3", "repl.12", replID)  ]



DMSO.s <- DMSO[ ,  list( DMSO.mean = mean( mod ), DMSO.sd = sd( mod ) ),  
                  by = list( cell_line, treatment, timeAfterExposure) ]

#treat doses of DMSO as replicates for variance stabilization, DMSO sd' s are introducing to much noise.

setkey(model.results.df, cell_line, timeAfterExposure)
setkey(DMSO.s, cell_line, timeAfterExposure)


model.results.df.stats <- DMSO.s[ model.results.df ] 
any(is.na(model.results.df.stats))

setkey(model.results.df.sd, cell_line, treatment, dose.f, timeAfterExposure )
setkey(model.results.df.stats, cell_line, treatment, dose.f, timeAfterExposure )

model.results.df.stats <- model.results.df.sd[model.results.df.stats]
model.results.df.stats[ treatment %in% "DMSO"]
# calculate mean difference over time (one-sided else cell death = significant:

model.results.df.stats[ , meanDiff :=  (mod - DMSO.mean)  / sqrt ( ( DMSO.sd^2 + treat.sd^2 + resid.SD^2 ) / 3)  ]  



Stats.m <- model.results.df.stats[, mean(meanDiff), by = list( cell_line, i.treatment, dose_uM, dose.f, replID  )]

Stats.m[, cell.treat.dose := paste( cell_line, i.treatment, dose.f, sep = "_")]


as.data.frame (Stats.m[ cell_line == "Nrf2" & i.treatment == "DMSO"])

setnames(Stats.m, "V1", "meanDiff")

Stats.m[ i.treatment %in% "DMSO" , cell.treat.dose := gsub("_[0-4]{1}", "", cell.treat.dose) ]

stats.out = alist()
stats.out.data = alist()
stats.out.data[[1]] <- data.frame( cell_line = NA, treatment = NA, dose_uM = NA, dose.f = NA, fstatistic = NA, pVal = NA  )   
all.vars <- unique(Stats.m$cell.treat.dose)
all.vars <- all.vars[! grepl("DMSO", all.vars)]


for( i in seq_along( all.vars )) {
 
  
  cur.cell_line <-unique( Stats.m[  cell.treat.dose %in% all.vars[ i ], cell_line ] )
  cur.treat <-unique( Stats.m[  cell.treat.dose %in% all.vars[ i ], i.treatment ] )
  subSet1 <- Stats.m[ cell.treat.dose %in% all.vars[ i ] ]
  subSetDMSO <- Stats.m[ i.treatment %in% "DMSO" & cell_line %in% cur.cell_line ]
  subSetDMSO <- subSetDMSO[ ,mean( meanDiff ), by = list( cell_line ,i.treatment,  dose_uM, dose.f, cell.treat.dose )] 
  setnames(subSetDMSO, "V1", "meanDiff")
  subSet1$replID <- NULL
  subSet <- rbind( subSetDMSO, subSet1)
  
  
  # one sided significance test
  subSet[ , i.treatment := factor(i.treatment, levels = c( "DMSO", cur.treat ))]
  #setnames(subSet, "V1", "meanDiff")
  stats.out[[i]] <- t.test(meanDiff ~ i.treatment, alternative = "less", var.equal = TRUE, data =   subSet)
  
  m.out<- stats.out[[i]] 

  
  
    stats.out.data[[i]] <- data.frame(cell_line = unique(subSet$cell_line),
                                    treatment = unique(subSet1$i.treatment),
                                    dose_uM = unique(subSet1$dose_uM),
                                    dose.f = unique(subSet1$dose.f),
                                    diffMeans = m.out$estimate[2] - m.out$estimate[1], 
                                    pVal = m.out$p.value)

}

stats.out.data.df <- do.call('rbind', stats.out.data)

getwd()

save.path <- "C:/Users/steve_000/Documents/work/POC paper/"

#load(paste(save.path, " freeze16052016.Rdata", sep = ""))
write.table(file = paste(save.path, "stats.out.data.df_3sd_6h.txt", sep =""), stats.out.data.df, sep ="\t", row.names = FALSE)
save.image(paste(save.path, "freeze16052016.Rdata"))
##TODO
# time course figuur + heatmap (heatmap vervangen alleen als visueel anders)
# stats dili compounds
# stats cytotox data

model1
difference <- the_data_m %>%
   left_join(
      the_data %>%
         group_by(time) %>%
         summarise(centre_1 = mean(blackbox1),
                   sd_1 = sd(blackbox1)),
      by = "time"
      ) %>%
   # bias correction because the centres are defined from blackbox1's data,
   # hence on average they will always be a little closer to them
   mutate(correction = ifelse(source == "blackbox1", max(trial) / (max(trial) - 1), 1)) %>%
   group_by(trial, source)%>%
   summarise(
      meandiff = mean(abs(value - centre_1) / sd_1 * correction))

   ggplot(difference, aes(x=meandiff, colour = source)) +
      geom_density() +
      ggtitle("Mean absolute standardise difference\nat each time point from the average of\nblackbox1 at that point")

   
   Comparison method
My method of comparison is based on assuming blackbox1 is the known good generator and we want to see if blackbox2 is plausibly the same. I do these steps:

calculate the average value at each point in time of the various instances of blackbox1, and the standard deviation of blackbox1s values at that point.
calculate how the absolute value of how different each instance of both series is from that average value, standardised by the standard deviation.
correct that difference value for blackbox1 by multiplying it by the (number of instances) / (number of instances - 1) , to control for the fact that the centre was defined by blackbox1 data and hence blackbox1 has a head start in trying to be close to the defined centre. In effect, I give it a degrees-of-freedom correction.
analyse the distribution of the differences to see if the instances of blackbox2 seem, on average, to be further away from the centres than are the instances of blackbox1.

model1 <- lm(meandiff ~ source, data = difference)
   

model.results.df.m <- ddply(model.results.df, .(cell_line, treatment, dose_uM, timeAfterExposure, dose.f),
      summarize, meanR = mean(mod, na.rm = TRUE))

head(model.results.df.m)

my.data.response$splitL <- paste(my.data.response$cell_line , my.data.response$treatment, my.data.response$dose_uM )
my.data.response.list <- split(my.data.response, my.data.response$splitL)

model.results.df.m$splitL <- paste(model.results.df.m$cell_line , model.results.df.m$treatment, model.results.df.m$dose_uM )
model.results.l.m <- split(model.results.df.m, model.results.df.m$splitL)


model.results.l.m[[5]]
my.data.response.list[[5]]

my.data.response.list[[1]]
     dir.create( paste( save.path, "model fit graphs means", sep ="") )
pdf(file = paste( save.path, "model fit graphs means/model fit graphs means_overfit.pdf", sep =""), height = 6, width = 6) 
      for(i in seq_along(model.results.l.m)){
       p <- ggplot(data =  model.results.l.m[[i]], aes(x=timeAfterExposure, y = meanR)) + geom_point() + 
          geom_point(data= my.data.response.list[[i]], aes(x=timeAfterExposure, y = minmaxNorm, color = replID)) + 
    ggtitle(unique(  c(my.data.response.list[[i]]$splitL),  unique( model.results.l.m[[i]]$splitL))) + ylim(c(0,1))
  print(p)
    }
dev.off()
  

# results of model stored in:
class(model.results.df.m)

# create dose levels
#  head(model.results.df.m)
# model.results.df.m$dose_uM <- as.numeric(model.results.df.m$dose_uM)  
# model.results.df.m <- model.results.df.m[  order( model.results.df.m[ , "cell_line"],
#                                                           model.results.df.m[ , "treatment"],
#                                                    model.results.df.m[ , "dose_uM"]),   ]
#   
# counts.d <- ddply(model.results.df.m, .(cell_line, treatment,timeAfterExposure ), summarize,count.d.l = length(dose_uM))
# head(counts.d)
# 
# model.results.df.m$dose.f <- NA
# for (i in 1 : nrow(counts.d))
# {
#   
#   model.results.df.m$dose.f[ model.results.df.m$treatment == counts.d$treatment[i] & 
#                       model.results.df.m$timeAfterExposure == counts.d$timeAfterExposure[i] &
#                             model.results.df.m$cell_line == counts.d$cell_line[i]] <- gl(counts.d$count.d.l[i], 1)
#   
# }

model.results.df.m[190:210,]
model.results.df.m$dose.f<- as.factor(model.results.df.m$dose.f)
# mean of reps

#save.image("freeeze15052016.Rdata")
head(stats.out.data.df)
head(model.results.df.m)

stats.out.data.df <- as.data.table(stats.out.data.df)
model.results.df.m <- as.data.table(model.results.df.m)

setkey(model.results.df.m, cell_line, treatment, dose_uM)
setkey(stats.out.data.df, cell_line, treatment, dose_uM)
model.results.df.m.stat <- stats.out.data.df[model.results.df.m]

lapply(model.results.df.m, class)
lapply(stats.out.data.df, class)
model.results.df.m[, dose.f := factor(dose.f)]
stats.out.data.df[ , dose.f := factor(dose.f)]


stats.out.data.df[ pVal > 0.05 , pval := ""]
stats.out.data.df[ pVal <= 0.05 , pval := "*"]
stats.out.data.df[ pVal <= 0.01 , pval := "**"]
stats.out.data.df[ pVal <= 0.001 , pval := "***"]

stats.out.data.df[, yloc := rev( 0.1*as.numeric(dose.f) + 0.6  )]


stats.out.data.df[ treatment == "Etoposide" & cell_line == "p21"]

model.results.df.m <- model.results.df.m[! (treatment %in% "DMSO" & dose.f == 4)]

pdf(paste(save.path, "timecourses_1sided_sd3_6h.pdf", sep =""), height = 14, width = 22)
p<-ggplot( model.results.df.m, aes(x=timeAfterExposure, y = meanR, color = dose.f)) +
  geom_line(aes(group = dose.f ), size = 2) + theme_sharp()
p <- p +  facet_grid( treatment~cell_line)
p <- p +  geom_text( data = stats.out.data.df, 
                     aes(x = 4, y =yloc, label =  pval ), size = 8) 

print(p)
dev.off()
stats.out.data.df[ cell_line == "CHOP"]

stats.out.data.df[ treatment %in% "Thapsigargin" & cell_line == "CHOP"]

?geom_text
unique(model.results.df.m[ , c("cell_line", "treatment", "dose_uM", "dose.f")])


dir()
load("14122015.Rdata.RData")
####hiergebleven load 14122015.Rdata

# create row-clustered heatmaps per cell line. Rows are treatment_dose and columns are ordered time points
# head(model.results.df.m)
# dim(model.results.df.m)
# require(reshape2)

sort(unique(unlist(cellineStr)))
model.results.df.m$treat.dose <- paste(model.results.df.m$treatment, model.results.df.m$dose_uM)
model.results.df.m$timeAfterExposure <- round(model.results.df.m$timeAfterExposure, digits= 2)
#data.cell <- model.results.df.m[ model.results.df.m$cell_line %in% "ATF4", ]
#my.data.w <-  dcast(data = data.cell, treat.dose~timeAfterExposure, value.var = "meanR" )

#max(my.data.w, na.rm=T)
#head(my.data.w)
#colnames(my.data.w) <- as.character(round(as.numeric(colnames(my.data.w)), digits=2))
#rownames(my.data.w) <- my.data.w$treat.dose
#my.data.w$treat.dose<- NULL
# define annotations treatment and reporter types:



# heatmap time!

getwd()
treatment_type <- c("light blue", "darkred", "green", "orange")
names(treatment_type) <-  c( "ox_stress","DDR","ER_stress", "control"  )
#write.table(treatmentAnot, file = "treatmentAnot2.txt", col.names=T, sep ="\t", row.names = F)
treatmentAnot <- read.table(file = "treatmentAnot.txt", sep ="\t", header = TRUE)
#treatmentAnot[ treatmentAnot$type == "DILI", "type"] <- "ox_stress"
colnames(treatmentAnot)<-c("treatment", "treatment_type")


library(RColorBrewer)
par(mar = c(0, 4, 0, 0))
display.brewer.all()

#my.colors <- c( "#ffffb2", "#fed976", "#feb24c", "#fd8d3c", "#f03b20", "#bd0026")
#hist(rep(1:10, 10), col =my.colors)


my.colors <- brewer.pal(9, "YlOrRd")

myColors <- list( treatment_type = treatment_type)

colBreaks <-c(seq(-0.01, 0.1,length.out=20), seq(0.101,1.01, length.out = 9))
length(colBreaks)

#replace Nrf2 stauro by mean of resp. rows to be able to cluster. Replace by NA afterwards


# the order of the rows is according to the mean values over time of the cell line / treat.dose matrix: (this was unsatisfactory)
# model.results.df.m.time <- ddply(model.results.df.m, .(cell_line, treatment, dose_uM, treat.dose), 
#                                  summarize, meanT = mean(meanR, na.rm=TRUE))
# my.data.w.all <-  dcast(data = model.results.df.m.time, treat.dose~cell_line, value.var = "meanT" )
# head(my.data.w.all)
# rownames(my.data.w.all) <- my.data.w.all$treat.dose
# my.data.w.all$treat.dose <- NULL
# 
# rowMeans(my.data.w.all, na.rm=T)
# my.data.w.all[ rownames(my.data.w.all) == "Staurosporin 10" , colnames(my.data.w.all) == "NFE2L2"] <- 0.05860408
# my.data.w.all[ rownames(my.data.w.all) == "Staurosporin 2.5" , colnames(my.data.w.all) == "NFE2L2"] <-0.07597052
# my.data.w.all[ rownames(my.data.w.all) == "Staurosporin 5" , colnames(my.data.w.all) == "NFE2L2"] <-  0.06218623

reporter_type <- c("light blue", "darkred", "green")
names(reporter_type) <- c("ox_stress", "DDR", "ER_stress")
reporterAnot<- data.frame(reporter_type = c("ER_stress", "DDR","ER_stress", "ER_stress", "ox_stress", "ox_stress", "DDR","ox_stress", "DDR", "DDR","ER_stress"))
colnames(reporterAnot)  <- "reporter_type"
myColors <- list(reporter_type = reporter_type, treatment_type = treatment_type)


# aheatmap(as.matrix((my.data.w.all)), Rowv = TRUE, Colv=TRUE, 
#           annRow = treatmentAnot, annCol = reporterAnot,  color = my.colors,
#          annColors = myColors,  fontsize = 10, width = 10, height=10, legend = FALSE,
#          distfun = "pearson", hclustfun ="ward"
#   )


model.results.df.m$cell.treat.dose <- paste(model.results.df.m$cell_line, model.results.df.m$treat.dose)
head(model.results.df.m)
comp.doses<- unique(model.results.df.m$treat.dose)

(head(model.results.df.m))
# comp.doses[26]
# 
# # make dummy staurosporin data for NFE2L2
# stauro_2.5 <- model.results.df.m[ model.results.df.m$treat.dose %in% comp.doses[26], ]
# head(stauro_2.5)
# stauro_2.5 <- ddply(stauro_2.5, .(treatment,  dose_uM, timeAfterExposure, dose.f), summarize, mean(meanR))
# stauro_2.5$cell_line <- "NFE2L2"
# stauro_2.5$splitL <- paste(stauro_2.5$cell_line, stauro_2.5$treatment, stauro_2.5$dose_uM)
# stauro_2.5$treat.dose<- paste( stauro_2.5$treatment, stauro_2.5$dose_uM)
# stauro_2.5$cell.treat.dose <- paste(stauro_2.5$cell_line, stauro_2.5$treatment, stauro_2.5$dose_uM)
#   head(stauro_2.5)
# head(model.results.df.m)
# colnames(stauro_2.5)[colnames(stauro_2.5) == "..1"] <- "meanR"
# model.results.df.m<- rbind(model.results.df.m, stauro_2.5)
# 
# 
# 
# stauro_5 <- model.results.df.m[ model.results.df.m$treat.dose %in% comp.doses[27], ]
# head(stauro_5)
# stauro_5 <- ddply(stauro_5, .(treatment,  dose_uM, timeAfterExposure, dose.f), summarize, mean(meanR))
# stauro_5$cell_line <- "NFE2L2"
# stauro_5$splitL <- paste(stauro_5$cell_line, stauro_5$treatment, stauro_5$dose_uM)
# stauro_5$treat.dose<- paste( stauro_5$treatment, stauro_5$dose_uM)
# stauro_5$cell.treat.dose <- paste(stauro_5$cell_line, stauro_5$treatment, stauro_5$dose_uM)
#   head(stauro_5)
# head(model.results.df.m)
# colnames(stauro_5)[colnames(stauro_5) == "..1"] <- "meanR"
# model.results.df.m<- rbind(model.results.df.m, stauro_5)
# 
# stauro_10 <- model.results.df.m[ model.results.df.m$treat.dose %in% comp.doses[28], ]
# head(stauro_10)
# stauro_10 <- ddply(stauro_10, .(treatment,  dose_uM, timeAfterExposure, dose.f), summarize, mean(meanR))
# stauro_10$cell_line <- "NFE2L2"
# stauro_10$splitL <- paste(stauro_10$cell_line, stauro_10$treatment, stauro_10$dose_uM)
# stauro_10$treat.dose<- paste( stauro_10$treatment, stauro_10$dose_uM)
# stauro_10$cell.treat.dose <- paste(stauro_10$cell_line, stauro_10$treatment, stauro_10$dose_uM)
#   head(stauro_10)
# head(model.results.df.m)
# colnames(stauro_10)[colnames(stauro_10) == "..1"] <- "meanR"
# model.results.df.m<- rbind(model.results.df.m, stauro_10)

?hclust
# 1) maak afstand tussen paarsgewijze cellijnen gebaseerd op alle compound.dose time courses, doe dit per compound.dose en dan gemiddelde en visa versa



#so recapitulation:
# 1) dmso background subtracted per reporter/plate. 
# 2) min max norm
# 3) modeled
# 4) mean of replicates
dist.treat.dose = list()
cells <-unique(model.results.df.m$cell_line)
norm.data = list()

for(i in  seq_along(cells)) {
  buffer.cells <- model.results.df.m[ model.results.df.m$cell_line %in% cells[i],]
  time.vectors.perCell <-  dcast(data = buffer.cells, treat.dose~timeAfterExposure, value.var = "meanR" )
  dim(time.vectors.perCell)
  rownames(time.vectors.perCell)<- time.vectors.perCell$treat.dose
  time.vectors.perCell$treat.dose <- NULL
 
  time.vectors.perCell<- as.matrix(time.vectors.perCell)
  
  # dit is al gedaan nu toch?
  #backgrDMSO75 <- time.vectors.perCell[ rownames(time.vectors.perCell) %in% "DMSO 75",]
  #time.vectors.perCell <- t(apply(time.vectors.perCell, MARGIN= 1,function(x) x - backgrDMSO75))
  
  dist.treat.dose[[i]] <- dist(time.vectors.perCell, 
method = c("euclidean", "maximum", "manhattan", "canberra", "binary" , "minkowski")[2], p=2,diag=TRUE)
  
  
  norm.data[[i]] <- melt(time.vectors.perCell)
  norm.data[[i]]$cell_line <- cells[i]
colnames(norm.data[[i]]) <- c("treat.dose", "timeAfterExposure", "meanR", "cell_line")
  }

all.norm.data <- do.call("rbind", norm.data)
class(all.norm.data)
head(all.norm.data)



dist.treat.dose[[1]]


dim(dist.treat.dose[[11]])

dist.treat.dose <- lapply(dist.treat.dose, function(x) x<- as.matrix(x))
my.array<- array(unlist(dist.treat.dose), c(27,27,11))



lapply(dist.treat.dose,  dim)
11*27*27-length(unlist(dist.treat.dose))  

dist.treat.dose.df <- apply(my.array, 1:2, mean)
rownames(dist.treat.dose.df) <- rownames(dist.treat.dose[[1]])
colnames(dist.treat.dose.df) <- colnames(dist.treat.dose[[1]])
dist.treat.dose.df.d <- as.dist(dist.treat.dose.df)
treat.dose.clust<-hclust(dist.treat.dose.df.d, method = "complete")
#c("ward.D", "ward.D2", "single", "complete", "average" , "mcquitty" , "median" , "centroid")

names(treat.dose.clust)
treat.dose.clust$labels
treat.dose.clust$order
results.treat.dose.order <- treat.dose.clust$labels[treat.dose.clust$order]
plot(treat.dose.clust)
?dist
?hclust
# same thing for the compounds
comp.doses<- unique(model.results.df.m$treat.dose)



dist.cells = list()
for(i in  seq_along(comp.doses)) {

  buffer.comp.dose <- all.norm.data[ all.norm.data$treat.dose %in% comp.doses[i],]
  time.vectors.perCompound <-  dcast(data = buffer.comp.dose, cell_line~timeAfterExposure, value.var = "meanR" )
  rownames(time.vectors.perCompound)<- time.vectors.perCompound$cell_line
  time.vectors.perCompound$cell_line <- NULL
  
  dist.cells[[i]] <- dist(time.vectors.perCompound, method = 
                            c("euclidean", "maximum", "manhattan", "canberra", "binary" , "minkowski")[2],  diag=TRUE)

}
?dist
dist.cells <- lapply(dist.cells, function(x) x<- as.matrix(x))
my.array<- array(unlist(dist.cells), c(11,11,28))
my.array[1,1,28]

dist.cells.df <- apply(my.array, 1:2, mean)
rownames(dist.cells.df) <- rownames(dist.cells[[1]])
colnames(dist.cells.df) <- colnames(dist.cells[[1]])
dist.cells.df.d <- as.dist(dist.cells.df)
my.members <- c("ER", "DDR", "ER", "ER","OX","OX",  "DDR",  "OX", "DDR", "DDR", "ER")
my.members <- c(1, 2, 1, 1,3,3,  2,  3, 2, 2, 1)
#members = my.members

cells.clust<-hclust(dist.cells.df.d, method = c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty" , "median" ,"centroid" )[4])
plot(cells.clust)
names(cells.clust)
cells.clust$labels
cells.clust$order
results.cell.order <- cells.clust$labels[cells.clust$order]
results.cell.order
plot(cells.clust)

?dist
?hclust

# 
# 
# aheatmap(as.matrix((my.data.w.all)), Rowv = NULL, Colv=NULL, 
 #          annRow = treatmentAnot, annCol = reporterAnot,  color = my.colors,
  #        annColors = myColors,  fontsize = 10, width = 10, height=10, legend = FALSE
          
   #)

length(reord.colnames) == length(unique(reord.colnames))

sort(rownames(my.data.w.all))
reord.rownames <- c( "Etoposide 6"   ,    "Etoposide 12.5"  ,  "Etoposide 25"   ,   "Cisplatin 5" ,      "Cisplatin 10"   ,  
"Cisplatin 20"    ,  "DMSO 100"       ,   "DMSO 50"    ,       "DMSO 25"       ,    "DMSO 75"     ,     
"CDDO 0.008"    ,    "CDDO 0.015"    ,    "CDDO 0.03"    ,     "IAA 2.5"    ,       "IAA 5"   ,         
 "IAA 10"        ,    "DEM 100"      ,     "DEM 25"       ,     "DEM 50"       ,     "Thapsigargin 1"   
, "Thapsigargin 0.25" ,"Thapsigargin 0.5",  "BFA 36"      ,      "BFA 18"        ,    "BFA 9"  ,          
 "Tunicamycin 3"  ,   "Tunicamycin 12" ,   "Tunicamycin 6"     )

results.cell.order
[1] "BiP"    "Atf4"   "CHOP"   "Xbp1"   "Btg2"   "p21"    "p53"    "p53BP1" "Srxn1"  "Keap1"  "Nrf2"  
>    
results.treat.dose.order

# now for each cell:
dir()
pic.place <- "D:/winks/Documents/own papers/stress response paper/modified figures for submission"
dir.create(paste(pic.place, "/fig3 live data cubic distance 2", sep=""))

cells


min(all.norm.data$meanR)
max(all.norm.data$meanR)
mean(all.norm.data$meanR)
my.colors

hmcols<-colorRampPalette(c("white","blue"))(256)

white <- hmcols[1]
lightestBlue <-hmcols[30]
lightBlue <- hmcols[80]
blue <- hmcols[128]
darkBlue <- hmcols[156]
darkerBlue <- hmcols[180]
darkestBlue <-hmcols[256]

my.seq<-seq(min(all.norm.data$meanR),max(all.norm.data$meanR), length.out=10)

#Breakwhite <- my.seq[2]
#BreaklightestBlue <- my.seq[3]
#BreaklightBlue<- my.seq[4]
#Breakblue <-  my.seq[5]
#BreakdarkBlue <- my.seq[6]
#BreakdarkerBlue <- my.seq[7]
#BreakdArkestBlue <- my.seq[8]

#myBreaks <-c(0, Breakwhite, BreaklightestBlue, BreaklightBlue, Breakblue, BreakdarkBlue, BreakdarkerBlue, BreakdArkestBlue) 

color_palette <- c(white, lightestBlue, lightBlue, blue, darkBlue, darkerBlue, darkestBlue)


myBreaks <- my.seq

for( i in seq_along(cells)){
data.cell <- all.norm.data[ all.norm.data$cell_line %in% cells[i], ]
my.data.w <-  dcast(data = data.cell, treat.dose~timeAfterExposure, value.var = "meanR" )
head(my.data.w)
rownames(my.data.w) <- my.data.w$treat.dose
my.data.w$treat.dose<- NULL
ind <- match(results.treat.dose.order, rownames(my.data.w))
my.data.w<- my.data.w[ind, ]
if(
!all(rownames(my.data.w)==results.treat.dose.order)
){
  stop()
}

ind2 <- match( rownames(my.data.w),treatmentAnot$treatment)
treatmentAnott <- treatmentAnot[ind2, "treatment_type", drop = F]



pdf(file = paste(pic.place, paste("fig3 live data cubic distance 2/", cells[i], ".pdf", sep =""), sep="/"), width = 5, height = 14)


    aheatmap(as.matrix((my.data.w)), color = c("#FFFFCC", "#FFEDA0" ,"#FED976" ,"#FEB24C" ,"#FD8D3C" ,"#FC4E2A" ,"#E31A1C" ,"#BD0026" ,"#800026"),
             #breaks = myBreaks
             Rowv = NA, Colv=NA, 
          annRow = treatmentAnott,  
         annColors = myColors,  fontsize = 10, legend = TRUE

  )

dev.off()
}




# old code starts here
#Srxn1:

AUC_Srxn1 <- read.delim(file = "/media/Image Data/POC/2012_12_06/TIFs/output/2012_12_06 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_Srxn1 <- read.delim(file = "/media/Image Data/POC/2012_12_06/TIFs/output/2012_12_06 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_Srxn1$cell <- "Srxn1"
summ_Srxn1$cell <- "Srxn1"

AUC_DDIT3 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/DDIT3/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_DDIT3 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/DDIT3/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_DDIT3$cell <- "DDIT3"
summ_DDIT3$cell <- "DDIT3"

AUC_HSPA5 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/HSPA5/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_HSPA5 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/HSPA5/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_HSPA5$cell <-"HSPA5"
summ_HSPA5$cell <- "HSPA5"

AUC_NFE2L2 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/NFE2L2/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_NFE2L2 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/NFE2L2/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_NFE2L2$cell <- "NFE2L2"
summ_NFE2L2$cell <- "NFE2L2" 

AUC_XBP1 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/XBP1/2013_01_16 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_XBP1 <- read.delim(file = "/media/Image Data/POC/2013_01_16/TIFs/output/XBP1/2013_01_16 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_XBP1$cell<- "XBP1"
summ_XBP1$cell <-"XBP1"

AUC_ATF4 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/ATF4/2012_12_10 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_ATF4 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/ATF4/2012_12_10 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_ATF4$cell<- "ATF4"
summ_ATF4$cell <-"ATF4"

AUC_TP53 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/TP53/2012_12_10 myData_AUC.csv", sep =",", header = T, row.names=1)
summ_TP53 <- read.delim(file = "/media/Image Data/POC/2012_12_10 part 1/tiffs_wells/output/TP53/2012_12_10 myData_summarized.csv", sep = ",", header = T, row.names = 1)
AUC_TP53$cell<- "TP53"
summ_TP53$cell <-"TP53"

# normalize data: scale the data according to positive control: this way the responses are scaled to each other
ind <- grep("deox" , AUC_Srxn1$treatment, ignore.case = TRUE )
AUC_Srxn1 <- AUC_Srxn1[-ind,]

ind <- grep("deox" , summ_Srxn1$treatment, ignore.case = TRUE )
summ_Srxn1[ind,]
summ_Srxn1 <- summ_Srxn1[-ind,]


#AUC_Srxn1_m <-  max(AUC_Srxn1$AUC)
#AUC_Srxn1$AUC <- AUC_Srxn1$AUC * (1 /  (100*AUC_Srxn1_m))
max(AUC_Srxn1$AUC)

ind <- grep("deox", AUC_DDIT3$treatment, ignore.case = TRUE )
AUC_DDIT3 <- AUC_DDIT3[-ind,]
#AUC_DDIT3_m <- max(AUC_DDIT3$AUC)
#AUC_DDIT3$AUC <- AUC_DDIT3$AUC * (1 / (100*AUC_DDIT3_m))
max(AUC_DDIT3$AUC)

ind <- grep("deox", AUC_HSPA5$treatment, ignore.case = TRUE )
AUC_HSPA5 <- AUC_HSPA5[-ind,]
#AUC_HSPA5_m <- max(AUC_HSPA5$AUC)
#AUC_HSPA5$AUC <- AUC_HSPA5$AUC * (1 / (100*AUC_HSPA5_m))
max(AUC_HSPA5$AUC)

ind <- grep("deox" , summ_HSPA5$treatment, ignore.case = TRUE )
summ_HSPA5[ind,]
summ_HSPA5 <- summ_HSPA5[-ind,]




ind <- grep("deox", AUC_NFE2L2$treatment, ignore.case = TRUE )
AUC_NFE2L2 <- AUC_NFE2L2[-ind,]
#AUC_NFE2L2_m <- max(AUC_NFE2L2$AUC)
#AUC_NFE2L2$AUC <- AUC_NFE2L2$AUC * (1 / (100*AUC_NFE2L2_m))
max(AUC_NFE2L2$AUC)

ind <- grep("deox", AUC_XBP1$treatment, ignore.case = TRUE )
AUC_XBP1 <- AUC_XBP1[-ind,]
#AUC_XBP1_m <- max(AUC_XBP1$AUC)
#AUC_XBP1$AUC <- AUC_XBP1$AUC * (1 / (100*AUC_XBP1_m))
max(AUC_XBP1$AUC)

ind <- grep("deox", AUC_ATF4$treatment, ignore.case = TRUE )
AUC_ATF4 <- AUC_ATF4[-ind,]
#AUC_ATF4_m <- max(AUC_ATF4$AUC)
#AUC_ATF4$AUC <- AUC_ATF4$AUC * (1 / (100*AUC_ATF4_m))
max(AUC_ATF4$AUC)

ind <- grep("deox", AUC_TP53$treatment, ignore.case = TRUE )
AUC_TP53 <- AUC_TP53[-ind,]
#AUC_TP53_m <- max(AUC_TP53$AUC)
#AUC_TP53$AUC <- AUC_TP53$AUC * (1 / (100*AUC_TP53_m))
max(AUC_TP53$AUC)

ind <- grep("deox" , summ_TP53$treatment, ignore.case = TRUE )
summ_TP53[ind,]
summ_TP53 <- summ_TP53[-ind,]



# plot heatmap
myData_AUC <- rbind(AUC_Srxn1, AUC_DDIT3, AUC_HSPA5, AUC_NFE2L2, AUC_XBP1, AUC_ATF4, AUC_TP53)

colnames(summ_Srxn1)[5] <-"Intensity"
colnames(summ_HSPA5)[5] <-"Intensity"
colnames(summ_TP53)[5] <-"Intensity"
myData_summ <- rbind( summ_Srxn1, summ_HSPA5, summ_TP53)
head(myData_summ)
colnames(myData_summ)[6] <- "Cell_Line"

colnames(myData_AUC)[3] <- "Cell_Line"
# myData_AUC$Stress_Response <- NA
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "TP53"] <- "DDR"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "Srxn1"] <- "OS"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "NFE2L2"] <- "OS"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "DDIT3"] <- "ER-stress"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "HSPA5"] <- "ER-stress"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "XBP1"] <- "ER-stress"
# myData_AUC$Stress_Response[ myData_AUC$Cell_Line == "ATF4"] <- "ER-stress"


myData_AUC$Compound_Type <- NA
myComps<-unique(myData_AUC$treatment)
myComps
ind <- grep( "CDDO" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "DEM" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "IAA" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "menadio" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"
ind <- grep( "H2O2" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "OS"


ind <- grep( "BFA" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "ER-stress"
ind <- grep( "tunica" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "ER-stress"
ind <- grep( "thapsi" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "ER-stress"

ind <- grep( "cispl" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "DDR"
ind <- grep( "etop" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "DDR"

ind <- grep( "DMSO" ,myData_AUC$treatment, ignore.case = TRUE ) 
myData_AUC[ind,]
myData_AUC$Compound_Type[ind ] <- "vehicle"



myData_AUC$Compound_Type[is.na(myData_AUC$Compound_Type)] <- "other"

myData_AUC$Compound_Type <- factor(myData_AUC$Compound_Type)
 


head(myData_AUC)

myData_AUC <- myData_AUC[ myData_AUC$treatment != "Menadione H", ]
myData_AUC <- myData_AUC[ myData_AUC$treatment != "Menadione M", ]
myData_AUC <- myData_AUC[ myData_AUC$treatment != "DMSO 75 %", ]

myData_summ <- myData_summ[ myData_summ$treatment != "Menadione H", ]
myData_summ <- myData_summ[ myData_summ$treatment != "Menadione M", ]
myData_summ <- myData_summ[ myData_summ$treatment != "DMSO 75 %", ]




AUC_Srxn1
AUC_DDIT3
AUC_HSPA5
AUC_NFE2L2
AUC_XBP1
AUC_ATF4
AUC_TP53
Srxn1 <- myData_AUC[ myData_AUC$Cell_Line=="Srxn1", c("treatment","AUC")]
DDIT3 <- myData_AUC[ myData_AUC$Cell_Line=="DDIT3", c("treatment","AUC")]
HSPA5 <- myData_AUC[ myData_AUC$Cell_Line=="HSPA5", c("treatment","AUC")]
NFE2L2 <- myData_AUC[ myData_AUC$Cell_Line=="NFE2L2", c("treatment","AUC")]
XBP1 <- myData_AUC[ myData_AUC$Cell_Line=="XBP1", c("treatment","AUC")]
ATF4 <- myData_AUC[ myData_AUC$Cell_Line=="ATF4", c("treatment","AUC")]
TP53 <- myData_AUC[ myData_AUC$Cell_Line=="TP53", c("treatment","AUC")]

myData_AUC_q <- cbind(Srxn1, DDIT3, HSPA5, NFE2L2, XBP1, ATF4, TP53)

rownames(myData_AUC_q) <- myData_AUC_q[,13]
myData_AUC_q <- myData_AUC_q[,-c(1,3,5,7,9,11,13)] 
colnames(myData_AUC_q ) <- c("Srxn1", "DDIT3", "HSPA5", "NFE2L2", "XBP1", "ATF4", "TP53")




Compound_Type <- c( "darkred", "limegreen", "blue", "pink", "lightblue")
names(Compound_Type) <- c("DDR", "ER-stress", "OS", "other", "vehicle")
myColors <- list(Compound_Type = Compound_Type)

zehDist <- c("manhattan","correlation", "euclidean")[3]
zehClust <- c("single" , "average", "ward", "complete", "centroid")[2]

 means.col <-  unlist(lapply(myData_AUC_q,  mean ))
  means.sd <-  unlist(lapply(myData_AUC_q,  sd ))
myData_AUC_q_n <-myData_AUC_q
head(myData_AUC_q_n)
myData_AUC_q_n$Srxn1 <-  (myData_AUC_q$Srxn1 - as.numeric(means.col["Srxn1"]) )/ as.numeric(means.sd["Srxn1"])
myData_AUC_q_n$DDIT3 <-  (myData_AUC_q$DDIT3 - means.col["DDIT3"]) / means.sd["DDIT3"]
myData_AUC_q_n$HSPA5 <-  (myData_AUC_q$HSPA5 - means.col["HSPA5"]) / means.sd["HSPA5"]
myData_AUC_q_n$NFE2L2 <-  (myData_AUC_q$NFE2L2 - means.col["NFE2L2"]) / means.sd["NFE2L2"]
myData_AUC_q_n$XBP1 <-  (myData_AUC_q$XBP1 - means.col["XBP1"]) / means.sd["XBP1"]
myData_AUC_q_n$ATF4 <-  (myData_AUC_q$ATF4 - means.col["ATF4"]) / means.sd["ATF4"]
myData_AUC_q_n$TP53 <-  (myData_AUC_q$TP53 - means.col["TP53"]) / means.sd["TP53"]



head(myData_AUC_q_n)



min(myData_AUC_q_n)

hmcols<-colorRampPalette(c("white","blue"))(256)

white <- hmcols[1]
lightestBlue <-hmcols[30]
lightBlue <- hmcols[80]
blue <- hmcols[128]
darkBlue <- hmcols[156]
darkerBlue <- hmcols[180]
darkestBlue <-hmcols[256]

my.seq<-seq(min(myData_AUC_q_n),max(myData_AUC_q_n), length.out=8)

Breakwhite <- my.seq[2]
BreaklightestBlue <- my.seq[3]
BreaklightBlue<- my.seq[4]
Breakblue <-  my.seq[5]
BreakdarkBlue <- my.seq[6]
BreakdarkerBlue <- my.seq[7]
BreakdArkestBlue <- my.seq[8]



  myBreaks <-c( Breakwhite, BreaklightestBlue, BreaklightBlue, Breakblue, BreakdarkBlue, BreakdarkerBlue, BreakdArkestBlue) 


color_palette <- c(white, lightestBlue, lightBlue, blue, darkBlue, darkerBlue, darkestBlue)

# set up myAnot data and quantitative data



head(myData_AUC)
myAnot <- data.frame( treatment = myData_AUC$treatment[ myData_AUC$Cell_Line=="TP53"], Compound_Type = myData_AUC$Compound_Type[ myData_AUC$Cell_Line == "TP53"  ])
rownames(myAnot) <- myAnot$treatment
myAnot$treatment <- NULL
head(myAnot)

sum(rownames(myAnot) != rownames(myData_AUC_q))

fontsize_row = 8; fontsize_col = 6;
pheatmap(t(as.matrix(myData_AUC_q_n)), col= color_palette, breaks =  myBreaks , main= "Specificity of Adaptive stress response Reporters",  
         fontsize_row=fontsize_row, fontsize_col =fontsize_col, border_color=NA, scale = "row",
         cluster_rows = TRUE, cluster_cols = TRUE, clustering_distance_rows = zehDist, 
         clustering_method = zehClust,  
          legend = TRUE, fontsize = 4,
          legend_breaks = round(myBreaks, digits=1), 
         annotation = myAnot, annotation_colors = myColors,
          display_numbers = F )






  
  
  #plot xy plots overlayed
head(myData_summ)
sum.means <- ddply(myData_summ, .(Cell_Line), function(x) mean(x$Intensity))
sum.sd <- ddply(myData_summ, .(Cell_Line), function(x) sd(x$Intensity))

myData_summ$Intensity[ myData_summ$Cell_Line=="Srxn1"] <- (myData_summ$Intensity[ myData_summ$Cell_Line=="Srxn1"] -
  sum.means$V1[ sum.means$Cell_Line == "Srxn1"]) /  sum.sd$V1[ sum.sd$Cell_Line == "Srxn1"]

myData_summ$Intensity[ myData_summ$Cell_Line=="HSPA5"] <- (myData_summ$Intensity[ myData_summ$Cell_Line=="HSPA5"] -
  sum.means$V1[ sum.means$Cell_Line == "HSPA5"]) /  sum.sd$V1[ sum.sd$Cell_Line == "HSPA5"]

myData_summ$Intensity[ myData_summ$Cell_Line=="TP53"] <- (myData_summ$Intensity[ myData_summ$Cell_Line=="TP53"] -
  sum.means$V1[ sum.means$Cell_Line == "TP53"]) /  sum.sd$V1[ sum.sd$Cell_Line == "TP53"]

#tijd van HSPA5 klopt niet
myData_summ$timeAfterExposure[ myData_summ$Cell_Line=="HSPA5"] <- myData_summ$timeAfterExposure[ myData_summ$Cell_Line=="HSPA5"] / 2

unique(myData_summ$treatment)

p<- ggplot( data = myData_summ, group = Cell_Line,  aes( x = timeAfterExposure , y = Intensity,  linetype = "Cell_Line", color = Cell_Line)) + geom_point(symbol =".", size = 1 ) 

p <- p + facet_wrap(~ treatment )
p <- p + theme( axis.text.x = element_text(angle = 90, hjust = 1, size = 14, colour = "grey50") ) + 
theme( strip.text.x = element_text( size = 14)) 
 p 
 











```